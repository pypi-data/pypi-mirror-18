---
resources:
    {% for sg in security_groups %}
    {{sg.name}}:
      Type: "AWS::EC2::SecurityGroup"
      Properties:
        GroupDescription: "{{sg.description}}"
        VpcId: {{vpc}}
        Tags:
            - Key: Name
              Value: {{sg.name}}
            {% if sg.description %}
            - Key: Description
              Value: {{sg.description}}
            {% endif %}
    {% if sg.egress_rules %}
    {% for rule in sg.egress_rules %}
    {{sg.name}}Egress{{loop.index}}:
      Type: "AWS::EC2::SecurityGroupEgress"
      Properties:
        GroupId:
            Ref: {{sg.name}}
        IpProtocol: {{rule.ip_protocol}}
        {% if rule.cidr_ip %}
        CidrIp: {{rule.cidr_ip}}
        {% endif %}
        {% if rule.from_port %}
        FromPort: {{rule.from_port}}
        {% endif %}
        {% if rule.to_port %}
        ToPort: {{rule.to_port}}
        {% endif %}
        {% if rule.source_security_group %}
        SourceSecurityGroupId: {{rule.source_security_group_id}}
        {% endif %}
    {% endfor %}  # Egress rule loop
    {% endif %}
    {% if sg.ingress_rules %}
    {% for rule in sg.ingress_rules %}
    {{sg.name}}Ingress{{loop.index}}:
      Type: "AWS::EC2::SecurityGroupIngress"
      Properties:
        GroupId:
            Ref: {{sg.name}}
        IpProtocol: {{rule.ip_protocol}}
        {% if rule.cidr_ip %}
        CidrIp: {{rule.cidr_ip}}
        {% endif %}
        {% if rule.from_port %}
        FromPort: {{rule.from_port}}
        {% endif %}
        {% if rule.to_port %}
        ToPort: {{rule.to_port}}
        {% endif %}
        {% if rule.source_security_group %}
        SourceSecurityGroupId: {{rule.source_security_group_id}}
        {% endif %}
    {% endfor %}  # Egress rule loop
    {% endif %}
    {% endfor %}  # Security group loop
