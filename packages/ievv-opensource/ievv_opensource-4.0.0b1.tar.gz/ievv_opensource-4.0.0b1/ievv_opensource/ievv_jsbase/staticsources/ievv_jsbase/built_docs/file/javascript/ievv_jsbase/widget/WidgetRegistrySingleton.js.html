<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">javascript/ievv_jsbase/widget/WidgetRegistrySingleton.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">ievv_jsbase</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/javascript/ievv_jsbase/SignalHandlerSingleton.js~ReceivedSignalInfo.html">ReceivedSignalInfo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/javascript/ievv_jsbase/SignalHandlerSingleton.js~SentSignalInfo.html">SentSignalInfo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/javascript/ievv_jsbase/SignalHandlerSingleton.js~SignalHandlerSingleton.html">SignalHandlerSingleton</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-makeCustomError">makeCustomError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DuplicateReceiverNameForSignal">DuplicateReceiverNameForSignal</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">ievv_jsbase/__testhelpers__</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/javascript/ievv_jsbase/__testhelpers__/XMLHttpRequestMock.js~XMLHttpRequestMock.html">XMLHttpRequestMock</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">ievv_jsbase/dom</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/javascript/ievv_jsbase/dom/DOMReplace.js~DOMReplace.html">DOMReplace</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/javascript/ievv_jsbase/dom/DOMReplaceFromUrl.js~DOMReplaceFromUrl.html">DOMReplaceFromUrl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/javascript/ievv_jsbase/dom/DOMReplaceWithSameElementFromUrl.js~DOMReplaceWithSameElementFromUrl.html">DOMReplaceWithSameElementFromUrl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/javascript/ievv_jsbase/dom/HtmlParser.js~HtmlParser.html">HtmlParser</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">ievv_jsbase/http</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/javascript/ievv_jsbase/http/HttpCookies.js~HttpCookies.html">HttpCookies</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/javascript/ievv_jsbase/http/HttpDjangoJsonRequest.js~HttpDjangoJsonRequest.html">HttpDjangoJsonRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/javascript/ievv_jsbase/http/HttpJsonRequest.js~JsonHttpRequest.html">JsonHttpRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/javascript/ievv_jsbase/http/HttpJsonResponse.js~HttpJsonResponse.html">HttpJsonResponse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/javascript/ievv_jsbase/http/HttpRequest.js~HttpRequest.html">HttpRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/javascript/ievv_jsbase/http/HttpResponse.js~HttpResponse.html">HttpResponse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/javascript/ievv_jsbase/http/QueryString.js~QueryString.html">QueryString</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/javascript/ievv_jsbase/http/UrlParser.js~UrlParser.html">UrlParser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-HttpCookieNotFoundError">HttpCookieNotFoundError</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">ievv_jsbase/log</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/javascript/ievv_jsbase/log/AbstractLogger.js~AbstractLogger.html">AbstractLogger</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/javascript/ievv_jsbase/log/Logger.js~Logger.html">Logger</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/javascript/ievv_jsbase/log/LoggerSingleton.js~LoggerSingleton.html">LoggerSingleton</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/javascript/ievv_jsbase/log/loglevel.js~LogLevels.html">LogLevels</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">ievv_jsbase/utils</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-onDocumentReady">onDocumentReady</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">ievv_jsbase/widget</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/javascript/ievv_jsbase/widget/AbstractWidget.js~AbstractWidget.html">AbstractWidget</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/javascript/ievv_jsbase/widget/WidgetRegistrySingleton.js~WidgetRegistrySingleton.html">WidgetRegistrySingleton</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ElementHasNoWidgetInstanceIdError">ElementHasNoWidgetInstanceIdError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ElementIsNotInitializedAsWidget">ElementIsNotInitializedAsWidget</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ElementIsNotWidgetError">ElementIsNotWidgetError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-InvalidWidgetAliasError">InvalidWidgetAliasError</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">javascript/ievv_jsbase/widget/WidgetRegistrySingleton.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import makeCustomError from &quot;../makeCustomError&quot;;

/**
 * The instance of the {@link WidgetRegistrySingleton}.
 */
let _instance = null;


/**
 * Exception thrown when an element where we expect the
 * ``data-ievv-jsbase-widget-instanceid`` attribute does
 * not have this attribute.
 *
 * @type {Error}
 */
export let ElementHasNoWidgetInstanceIdError = makeCustomError(&apos;ElementHasNoWidgetInstanceIdError&apos;);


/**
 * Exception thrown when an element that we expect to have
 * the ``data-ievv-jsbase-widget`` attribute does not have
 * this attribute.
 *
 * @type {Error}
 */
export let ElementIsNotWidgetError = makeCustomError(&apos;ElementIsNotWidgetError&apos;);


/**
 * Exception thrown when an element has a
 * ``data-ievv-jsbase-widget`` with a value that
 * is not an alias registered in the {@link WidgetRegistrySingleton}.
 *
 * @type {Error}
 */
export let InvalidWidgetAliasError = makeCustomError(&apos;InvalidWidgetAliasError&apos;);


/**
 * Exception thrown when an element with the
 * ``data-ievv-jsbase-widget-instanceid=&lt;widgetInstanceId&gt;`` attribute is not in
 * the {@link WidgetRegistrySingleton} with ``&lt;widgetInstanceId&gt;``.
 *
 * @type {Error}
 */
export let ElementIsNotInitializedAsWidget = makeCustomError(&apos;ElementIsNotInitializedAsWidget&apos;);


/**
 * A very lightweight widget system.
 *
 * Basic example below - see {@link AbstractWidget} for more examples.
 *
 * @example &lt;caption&gt;Create a very simple widget&lt;/caption&gt;
 * export default class OpenMenuWidget extends AbstractWidget {
 *     constructor(element) {
 *          super(element);
 *          this._onClickBound = (...args) =&gt; {
 *              this._onClick(...args);
 *          };
 *          this.element.addEventListener(&apos;click&apos;, this._onClickBound);
 *     }
 *
 *     _onClick = (e) =&gt; {
 *          e.preventDefault();
 *          console.log(&apos;I should have opened the menu here&apos;);
 *     }
 *
 *     destroy() {
 *          this.element.removeEventListener(&apos;click&apos;, this._onClickBound);
 *     }
 * }
 *
 * @example &lt;caption&gt;Use the widget&lt;/caption&gt;
 * &lt;button data-ievv-jsbase-widget=&quot;open-menu-button&quot; type=&quot;button&quot;&gt;
 *     Open menu
 * &lt;/button&gt;
 *
 * @example &lt;caption&gt;Register and load widgets&lt;/caption&gt;
 * // Somewhere that is called after all the widgets are rendered
 * // - typically at the end of the &lt;body&gt;
 * import WidgetRegistrySingleton from &apos;ievv_jsbase/widget/WidgetRegistrySingleton&apos;;
 * import OpenMenuWidget from &apos;path/to/OpenMenuWidget&apos;;
 * const widgetRegistry = new WidgetRegistrySingleton();
 * widgetRegistry.registerWidgetClass(&apos;open-menu-button&apos;, OpenMenuWidget);
 * widgetRegistry.initializeAllWidgetsWithinElement(document.body);
 *
 */
export default class WidgetRegistrySingleton {
    constructor() {
        if (!_instance) {
            _instance = this;
            this._initialize();
        }
        return _instance;
    }

    _initialize() {
        this._widgetAttribute = &apos;data-ievv-jsbase-widget&apos;;
        this._widgetInstanceIdAttribute = &apos;data-ievv-jsbase-widget-instanceid&apos;;
        this._widgetClassMap = new Map();
        this._widgetInstanceMap = new Map();
        this._widgetInstanceCounter = 0;
    }

    clear() {
        // TODO: Call destroyAllWidgetsWithinDocumentBody()
        this._widgetClassMap.clear();
        this._widgetInstanceMap.clear();
        this._widgetInstanceCounter = 0;
    }

    /**
     * Register a widget class in the registry.
     *
     * @param {string} alias The alias for the widget. This is the string that
     *      is used as the attribute value with the ``data-ievv-jsbase-widget``
     *      DOM element attribute.
     * @param {AbstractWidget} WidgetClass The widget class.
     */
    registerWidgetClass(alias, WidgetClass) {
        this._widgetClassMap.set(alias, WidgetClass);
    }

    /**
     * Remove widget class from registry.
     *
     * @param alias The alias that the widget class was registered with
     *      by using {@link WidgetRegistrySingleton#registerWidgetClass}.
     */
    removeWidgetClass(alias) {
        this._widgetClassMap.delete(alias);
    }

    /**
     * Initialize the provided element as a widget.
     *
     * @param {Element} element The DOM element to initalize as a widget.
     *
     * @throws {ElementIsNotWidgetError} If the element does not have
     *      the ``data-ievv-jsbase-widget`` attribute.
     * @throws {InvalidWidgetAliasError} If the widget alias is not in this registry.
     */
    initializeWidget(element) {
        let alias = element.getAttribute(this._widgetAttribute);
        if(!alias) {
            throw new ElementIsNotWidgetError(
                `The\n\n${element.outerHTML}\n\nelement has no or empty` +
                `${this._widgetAttribute} attribute.`);
        }
        if(!this._widgetClassMap.has(alias)) {
            throw new InvalidWidgetAliasError(`No WidgetClass registered with the &quot;${alias}&quot; alias.`);
        }
        let WidgetClass = this._widgetClassMap.get(alias);
        let widget = new WidgetClass(element);
        this._widgetInstanceCounter ++;
        let widgetInstanceId = this._widgetInstanceCounter.toString();
        this._widgetInstanceMap.set(widgetInstanceId, widget);
        element.setAttribute(this._widgetInstanceIdAttribute, widgetInstanceId);
        return widget;
    }

    _getAllWidgetElementsWithinElement(element) {
        return element.querySelectorAll(`[${this._widgetAttribute}]`);
    }

    /**
     * Initialize all widgets within the provided element.
     *
     * @param {Element} element A DOM element.
     */
    initializeAllWidgetsWithinElement(element) {
        for(let widgetElement of this._getAllWidgetElementsWithinElement(element)) {
            this.initializeWidget(widgetElement);
        }
    }

    /**
     * Get the value of the ``data-ievv-jsbase-widget-instanceid`` attribute
     * of the provided element.
     *
     * @param {Element} element A DOM element.
     * @returns {null|string}
     */
    getWidgetInstanceIdFromElement(element) {
        return element.getAttribute(this._widgetInstanceIdAttribute);
    }

    /**
     * Get a widget instance by its widget instance id.
     *
     * @param widgetInstanceId A widget instance id.
     * @returns {AbstractWidget} A widget instance or ``null``.
     */
    getWidgetInstanceByInstanceId(widgetInstanceId) {
        return this._widgetInstanceMap.get(widgetInstanceId);
    }

    /**
     * Destroy the widget on the provided element.
     *
     * @param {Element} element A DOM element that has been initialized by
     *      {@link WidgetRegistrySingleton#initializeWidget}.
     *
     * @throws {ElementHasNoWidgetInstanceIdError} If the element has
     *      no ``data-ievv-jsbase-widget-instanceid`` attribute or the
     *      attribute value is empty. This normally means that
     *      the element is not a widget, or that the widget
     *      is not initialized.
     * @throws {ElementIsNotInitializedAsWidget} If the element
     *      has the ``data-ievv-jsbase-widget-instanceid`` attribute
     *      but the value of the attribute is not a valid widget instance
     *      id. This should not happen unless you manipulate the
     *      attribute manually or use the private members of this registry.
     */
    destroyWidget(element) {
        let widgetInstanceId = this.getWidgetInstanceIdFromElement(element);
        if(widgetInstanceId) {
            let widgetInstance = this.getWidgetInstanceByInstanceId(widgetInstanceId);
            if(widgetInstance) {
                widgetInstance.destroy();
                this._widgetInstanceMap.delete(widgetInstanceId);
                element.removeAttribute(this._widgetInstanceIdAttribute);
            } else {
                throw new ElementIsNotInitializedAsWidget(
                    `Element\n\n${element.outerHTML}\n\nhas the ` +
                    `${this._widgetInstanceIdAttribute} attribute, but the id is ` +
                    `not in the widget registry.`);
                }
        } else {
            throw new ElementHasNoWidgetInstanceIdError(
                `Element\n\n${element.outerHTML}\n\nhas no or empty ` +
                `${this._widgetInstanceIdAttribute} attribute.`);
        }
    }

    _getAllInstanciatedWidgetElementsWithinElement(element) {
        return element.querySelectorAll(`[${this._widgetInstanceIdAttribute}]`);
    }

    /**
     * Destroy all widgets within the provided element.
     * Only destroys widgets on elements that is a child of the element.
     *
     * @param {Element} element The DOM Element.
     */
    destroyAllWidgetsWithinElement(element) {
        for(let widgetElement of this._getAllInstanciatedWidgetElementsWithinElement(element)) {
            this.destroyWidget(widgetElement);
        }
    }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.8)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
