<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>PyZgoubi Documentation &mdash; PyZgoubi 0.6.0 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.6.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="PyZgoubi 0.6.0 documentation" href="index.html" />
    <link rel="next" title="API Reference" href="api.html" />
    <link rel="prev" title="PyZgoubi Installation" href="install.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="api.html" title="API Reference"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="install.html" title="PyZgoubi Installation"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">PyZgoubi 0.6.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="pyzgoubi-documentation">
<h1>PyZgoubi Documentation<a class="headerlink" href="#pyzgoubi-documentation" title="Permalink to this headline">¶</a></h1>
<p>The latest version of PyZgoubi and this document can be found at <a class="reference external" href="http://www.hep.manchester.ac.uk/u/samt/pyzgoubi/">http://www.hep.manchester.ac.uk/u/samt/pyzgoubi/</a></p>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="http://sourceforge.net/projects/zgoubi">Zgoubi</a> is a particle tracking code maintained by François Méot. PyZgoubi is an interface to Zgoubi written in python. It aims to make input files that are easy to read and can contain calculations, loops, and any other python program feature.</p>
<p>A basic knowledge of <a class="reference external" href="http://python.org/">Python</a> is useful to use PyZgoubi. Python is a general purpose, high level, interpreted programming language. I recommend the <a class="reference external" href="http://docs.python.org/tutorial/">Official Python Tutorial</a>.</p>
</div>
<div class="section" id="quick-start">
<h2>Quick Start<a class="headerlink" href="#quick-start" title="Permalink to this headline">¶</a></h2>
<p>Put the following in a text file named quickstart.py:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">make_line</span><span class="p">(</span><span class="s1">&#39;line&#39;</span><span class="p">)</span>

<span class="c1"># create and OBJET2 and add 1 electron to it</span>
<span class="n">ob</span> <span class="o">=</span> <span class="n">OBJET2</span><span class="p">()</span>
<span class="n">ob</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">BORO</span><span class="o">=</span><span class="n">ke_to_rigidity</span><span class="p">(</span><span class="mf">10e6</span><span class="p">,</span> <span class="n">ELECTRON_MASS</span><span class="p">))</span>
<span class="n">ob</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">D</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="n">ob</span><span class="p">)</span>

<span class="n">add</span><span class="p">(</span><span class="n">FAISCNL</span><span class="p">(</span><span class="n">FNAME</span><span class="o">=</span><span class="s1">&#39;zgoubi.fai&#39;</span><span class="p">))</span> <span class="c1"># record point</span>
<span class="n">d1</span> <span class="o">=</span> <span class="n">DRIFT</span><span class="p">(</span><span class="n">XL</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">q1</span> <span class="o">=</span> <span class="n">QUADRUPO</span><span class="p">(</span><span class="n">XL</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">B_0</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">R_0</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">XPAS</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">d2</span> <span class="o">=</span> <span class="n">DRIFT</span><span class="p">(</span><span class="n">XL</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">q2</span> <span class="o">=</span> <span class="n">QUADRUPO</span><span class="p">(</span><span class="n">XL</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">B_0</span><span class="o">=-</span><span class="mi">5</span><span class="p">,</span> <span class="n">R_0</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">XPAS</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">add</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">q1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">q2</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="n">FAISCNL</span><span class="p">(</span><span class="n">FNAME</span><span class="o">=</span><span class="s1">&#39;zgoubi.fai&#39;</span><span class="p">))</span> <span class="c1"># record point</span>
<span class="n">add</span><span class="p">(</span><span class="n">END</span><span class="p">())</span>

<span class="k">print</span> <span class="n">output</span><span class="p">()</span> <span class="c1"># file fed to zgoubi (zgoubi.dat)</span>
<span class="n">run</span><span class="p">()</span> <span class="c1"># run the line in zgoubi</span>
<span class="k">print</span> <span class="n">res</span><span class="p">()</span> <span class="c1"># show the zgoubi.res file</span>
<span class="k">print</span> <span class="n">get_all</span><span class="p">(</span><span class="s1">&#39;fai&#39;</span><span class="p">)</span> <span class="c1"># so the data recorded with FAISCNL</span>
</pre></div>
</div>
<p>The file can also be found in examples/quickstart.py</p>
<p>Run it with:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>pyzgoubi quickstart.py
</pre></div>
</div>
<p>You should see the zgoubi data file, the output from zgoubi, the res file from zgoubi, and the coordinates at the 2 FAISCNL points displayed to the terminal.</p>
<p>For more advance use it may be better store the <a class="reference internal" href="api.html#zgoubi.core.Line" title="zgoubi.core.Line"><tt class="xref py py-class docutils literal"><span class="pre">Line</span></tt></a> with a name, this allows you to work with multiple <a class="reference internal" href="api.html#zgoubi.core.Line" title="zgoubi.core.Line"><tt class="xref py py-class docutils literal"><span class="pre">Lines</span></tt></a> simultaneously. The following shows the same file, but with a named <a class="reference internal" href="api.html#zgoubi.core.Line" title="zgoubi.core.Line"><tt class="xref py py-class docutils literal"><span class="pre">Line</span></tt></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">myline</span> <span class="o">=</span> <span class="n">Line</span><span class="p">(</span><span class="s1">&#39;line&#39;</span><span class="p">)</span>

<span class="c1"># create and OBJET2 and add 1 electron to it</span>
<span class="n">ob</span> <span class="o">=</span> <span class="n">OBJET2</span><span class="p">()</span>
<span class="n">ob</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">BORO</span><span class="o">=</span><span class="n">ke_to_rigidity</span><span class="p">(</span><span class="mf">10e6</span><span class="p">,</span> <span class="n">ELECTRON_MASS</span><span class="p">))</span>
<span class="n">ob</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">D</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">myline</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ob</span><span class="p">)</span>

<span class="n">myline</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">FAISCNL</span><span class="p">(</span><span class="n">FNAME</span><span class="o">=</span><span class="s1">&#39;zgoubi.fai&#39;</span><span class="p">))</span> <span class="c1"># record point</span>
<span class="n">d1</span> <span class="o">=</span> <span class="n">DRIFT</span><span class="p">(</span><span class="n">XL</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">q1</span> <span class="o">=</span> <span class="n">QUADRUPO</span><span class="p">(</span><span class="n">XL</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">B_0</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">R_0</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">XPAS</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">d2</span> <span class="o">=</span> <span class="n">DRIFT</span><span class="p">(</span><span class="n">XL</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">q2</span> <span class="o">=</span> <span class="n">QUADRUPO</span><span class="p">(</span><span class="n">XL</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">B_0</span><span class="o">=-</span><span class="mi">5</span><span class="p">,</span> <span class="n">R_0</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">XPAS</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">myline</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">q1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">q2</span><span class="p">)</span>
<span class="n">myline</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">FAISCNL</span><span class="p">(</span><span class="n">FNAME</span><span class="o">=</span><span class="s1">&#39;zgoubi.fai&#39;</span><span class="p">))</span> <span class="c1"># record point</span>
<span class="n">myline</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">END</span><span class="p">())</span>

<span class="k">print</span> <span class="n">myline</span><span class="o">.</span><span class="n">output</span><span class="p">()</span> <span class="c1"># file fed to zgoubi (zgoubi.dat)</span>
<span class="n">myresults</span> <span class="o">=</span> <span class="n">myline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span> <span class="c1"># run the line in zgoubi</span>
<span class="k">print</span> <span class="n">myresults</span><span class="o">.</span><span class="n">res</span><span class="p">()</span> <span class="c1"># show the zgoubi.res file</span>
<span class="k">print</span> <span class="n">myresults</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="s1">&#39;fai&#39;</span><span class="p">)</span> <span class="c1"># so the data recorded with FAISCNL</span>
</pre></div>
</div>
</div>
<div class="section" id="generating-zgoubi-dat-files">
<h2>Generating zgoubi.dat files<a class="headerlink" href="#generating-zgoubi-dat-files" title="Permalink to this headline">¶</a></h2>
<p>The simplest level of Pyzgoubi is to use it to generate a zgoubi.dat file. You can then run Zgoubi with the file to get your results.</p>
<p>PyZgoubi works with <a class="reference internal" href="api.html#zgoubi.core.Line" title="zgoubi.core.Line"><tt class="xref py py-class docutils literal"><span class="pre">Lines</span></tt></a>, which are made up of Elements. The Elements are mostly the same as those used in Zgoubi. Most Elements correspond to magnets and other beam line elements of a physical accelerator, e.g. DIPOLE, MUTIPOL and CAVITE. Some are used to define the beam e.g. OBJET2. Some are to control the execution of Zgoubi, e.g. FAISCNL, MATRIX and END. A number of these Elements can be added to a <a class="reference internal" href="api.html#zgoubi.core.Line" title="zgoubi.core.Line"><tt class="xref py py-class docutils literal"><span class="pre">Line</span></tt></a>. This <a class="reference internal" href="api.html#zgoubi.core.Line" title="zgoubi.core.Line"><tt class="xref py py-class docutils literal"><span class="pre">Line</span></tt></a> then has all the information needed to make a zgoubi.dat file.</p>
<p>A <a class="reference internal" href="api.html#zgoubi.core.Line" title="zgoubi.core.Line"><tt class="xref py py-class docutils literal"><span class="pre">Line</span></tt></a> can be created as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">emma</span> <span class="o">=</span> <span class="n">Line</span><span class="p">(</span><span class="s1">&#39;emma simulation&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>emma is the name used to refer to the <a class="reference internal" href="api.html#zgoubi.core.Line" title="zgoubi.core.Line"><tt class="xref py py-class docutils literal"><span class="pre">Line</span></tt></a> in the program. &#8216;emma simulation&#8217; is the text that will be put at the start of the zgoubi.dat file.</p>
<p>To create an Element use:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">q1</span> <span class="o">=</span> <span class="n">QUADRUPO</span><span class="p">(</span><span class="s1">&#39;defoc&#39;</span><span class="p">,</span> <span class="n">XL</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">R_0</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">B_0</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">XPAS</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
<p>This can now be added to the <a class="reference internal" href="api.html#zgoubi.core.Line" title="zgoubi.core.Line"><tt class="xref py py-class docutils literal"><span class="pre">Line</span></tt></a></p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">emma</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">q1</span><span class="p">)</span>
</pre></div>
</div>
<p>These last 2 steps can be contracted:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">emma</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">QUADRUPO</span><span class="p">(</span><span class="s1">&#39;defoc&#39;</span><span class="p">,</span> <span class="n">XL</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">R_0</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">B_0</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">XPAS</span><span class="o">=</span><span class="mf">0.1</span><span class="p">))</span>
</pre></div>
</div>
<p>however this means that there is no reference to the element that could be used for modifying its parameters later, e.g.:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">q1</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">B_0</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="api.html#zgoubi.core.Line" title="zgoubi.core.Line"><tt class="xref py py-class docutils literal"><span class="pre">Line</span></tt></a> can now be used to output a zgoubi.dat using the output() function:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">print</span> <span class="n">emma</span><span class="o">.</span><span class="n">output</span><span class="p">()</span>
</pre></div>
</div>
<p>All these instructions can be put in a text file and run using the command pyzgoubi. (pyzgoubi is an alias set up by the installer). Below is a section of emma.py from the examples:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">emma</span> <span class="o">=</span> <span class="n">Line</span><span class="p">(</span><span class="s1">&#39;emma&#39;</span><span class="p">)</span>
<span class="n">xpas</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span>

<span class="n">cells</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">angle</span> <span class="o">=</span> <span class="mi">360</span><span class="o">/</span><span class="n">cells</span>
<span class="n">d_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mf">34.048</span> <span class="o">*</span> <span class="n">mm</span>
<span class="n">f_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mf">7.514</span> <span class="o">*</span> <span class="n">mm</span>

<span class="c1">#lengths</span>
<span class="n">ld</span> <span class="o">=</span> <span class="mi">210</span> <span class="o">*</span> <span class="n">mm</span>
<span class="n">sd</span> <span class="o">=</span> <span class="mi">50</span> <span class="o">*</span> <span class="n">mm</span>

<span class="n">fq</span> <span class="o">=</span> <span class="mf">58.782</span> <span class="o">*</span> <span class="n">mm</span>
<span class="n">dq</span> <span class="o">=</span> <span class="mf">75.699</span> <span class="o">*</span> <span class="n">mm</span>

<span class="c1"># quad radius</span>
<span class="n">fr</span> <span class="o">=</span> <span class="mi">37</span> <span class="o">*</span> <span class="n">mm</span>
<span class="n">dr</span> <span class="o">=</span> <span class="mi">53</span> <span class="o">*</span> <span class="n">mm</span>

<span class="n">fb</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.695</span> <span class="o">*</span> <span class="n">fr</span> <span class="o">*</span> <span class="n">T</span>
<span class="n">db</span> <span class="o">=</span> <span class="mf">4.704</span> <span class="o">*</span> <span class="n">dr</span> <span class="o">*</span> <span class="n">T</span>

<span class="n">ob</span> <span class="o">=</span> <span class="n">OBJET2</span><span class="p">()</span>
<span class="n">emma</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ob</span><span class="p">)</span>

<span class="n">emma</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ELECTRON</span><span class="p">())</span>

<span class="n">emma</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">DRIFT</span><span class="p">(</span><span class="s1">&#39;ld&#39;</span><span class="p">,</span> <span class="n">XL</span><span class="o">=</span><span class="n">ld</span><span class="o">*</span><span class="n">cm_</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
<span class="n">emma</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">CHANGREF</span><span class="p">(</span><span class="n">ALE</span><span class="o">=</span><span class="n">angle</span><span class="p">))</span>

<span class="n">emma</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">CHANGREF</span><span class="p">(</span><span class="n">YCE</span><span class="o">=</span><span class="n">d_offset</span><span class="o">*</span><span class="n">cm_</span><span class="p">))</span>
<span class="n">emma</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">QUADRUPO</span><span class="p">(</span><span class="s1">&#39;defoc&#39;</span><span class="p">,</span> <span class="n">XL</span><span class="o">=</span><span class="n">dq</span><span class="o">*</span><span class="n">cm_</span><span class="p">,</span> <span class="n">R_0</span><span class="o">=</span><span class="n">dr</span><span class="o">*</span><span class="n">cm_</span><span class="p">,</span> <span class="n">B_0</span><span class="o">=</span><span class="n">db</span><span class="o">*</span><span class="n">kgauss_</span><span class="p">,</span> <span class="n">XPAS</span><span class="o">=</span><span class="n">xpas</span><span class="p">))</span>

<span class="n">emma</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">CHANGREF</span><span class="p">(</span><span class="n">YCE</span><span class="o">=-</span><span class="n">d_offset</span><span class="o">*</span><span class="n">cm_</span><span class="p">))</span>

<span class="n">emma</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">DRIFT</span><span class="p">(</span><span class="s1">&#39;sd&#39;</span><span class="p">,</span> <span class="n">XL</span><span class="o">=</span><span class="n">sd</span><span class="o">*</span><span class="n">cm_</span><span class="p">))</span>

<span class="n">emma</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">CHANGREF</span><span class="p">(</span><span class="n">YCE</span><span class="o">=</span><span class="n">f_offset</span><span class="o">*</span><span class="n">cm_</span><span class="p">))</span>
<span class="n">emma</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">QUADRUPO</span><span class="p">(</span><span class="s1">&#39;foc&#39;</span><span class="p">,</span> <span class="n">XL</span><span class="o">=</span><span class="n">fq</span><span class="o">*</span><span class="n">cm_</span><span class="p">,</span> <span class="n">R_0</span><span class="o">=</span><span class="n">fr</span><span class="o">*</span><span class="n">cm_</span><span class="p">,</span> <span class="n">B_0</span><span class="o">=</span><span class="n">fb</span><span class="o">*</span><span class="n">kgauss_</span><span class="p">,</span> <span class="n">XPAS</span><span class="o">=</span><span class="n">xpas</span><span class="p">))</span>
<span class="n">emma</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">CHANGREF</span><span class="p">(</span><span class="n">YCE</span><span class="o">=-</span><span class="n">f_offset</span><span class="o">*</span><span class="n">cm_</span><span class="p">))</span>

<span class="n">emma</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">DRIFT</span><span class="p">(</span><span class="s1">&#39;ld&#39;</span><span class="p">,</span> <span class="n">XL</span><span class="o">=</span><span class="n">ld</span><span class="o">*</span><span class="n">cm_</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>

<span class="n">emma</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">FAISCNL</span><span class="p">(</span><span class="n">FNAME</span><span class="o">=</span><span class="s1">&#39;zgoubi.fai&#39;</span><span class="p">))</span>

<span class="n">emma</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">REBELOTE</span><span class="p">(</span><span class="n">K</span><span class="o">=</span><span class="mi">99</span><span class="p">,</span> <span class="n">NPASS</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>

<span class="n">emma</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">END</span><span class="p">())</span>

<span class="n">rigidity</span> <span class="o">=</span> <span class="n">ke_to_rigidity</span><span class="p">(</span><span class="mf">10e6</span><span class="p">,</span> <span class="mf">0.51099892e6</span><span class="p">)</span>
<span class="n">ob</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">BORO</span><span class="o">=-</span><span class="n">rigidity</span><span class="p">)</span>
<span class="n">ob</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">D</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="k">print</span> <span class="n">emma</span><span class="o">.</span><span class="n">output</span><span class="p">()</span>
</pre></div>
</div>
<p>This can be run with the command:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>pyzgoubi emma.py
</pre></div>
</div>
<p>It will build a <a class="reference internal" href="api.html#zgoubi.core.Line" title="zgoubi.core.Line"><tt class="xref py py-class docutils literal"><span class="pre">Line</span></tt></a> and print the zgoubi.dat input to the screen. The &#8216;.py&#8217; extension is not necessary, but will cause your text editor to use python syntax highlighting.</p>
<div class="section" id="particles-particuls">
<h3>Particles / Particuls<a class="headerlink" href="#particles-particuls" title="Permalink to this headline">¶</a></h3>
<p>Zgoubi allows a particles parameters such as charge, mass and half-life to be set with the PARTICUL element. These not needed for basic tracking, as the rigidity is given in the OBJET element. PyZgoubi offers some pre-made particles:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">ELECTRON</span>
<span class="n">PROTON</span>
<span class="n">MUON</span>
<span class="n">IMMORTAL_MUON</span>
</pre></div>
</div>
<p>The IMMORTAL_MUON is a muon with an infinite lifetime, for use when decay is not needed. Anti particles with opposite can me made by negating a particle. eg:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="o">-</span><span class="n">MUON</span><span class="p">()</span>
<span class="n">my_line</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="c1">#or</span>
<span class="n">my_line</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">-</span><span class="n">MUON</span><span class="p">())</span>
</pre></div>
</div>
<p>The masses and charges are defined in zgoubi/constants.py</p>
</div>
</div>
<div class="section" id="defining-elements">
<h2>Defining Elements<a class="headerlink" href="#defining-elements" title="Permalink to this headline">¶</a></h2>
<p>There are two ways Elements can be defined in pyzgoubi. Most Elements are simple, they have a static list of parameters. Some have some extra complexity, for example different parameters depending on options, sections repeated N times. These elements can be defined using a simple syntax, which is then converted into python code. More complex elements must be written in python.</p>
<p>The simple elements are defined in defs/simple_elements.defs. For each element there is a number of lines of text, delimited by blank lines. Comments can be put after a &#8216;#&#8217; character. The first line gives the name of the class, this is the name you use in the input file. The second line gives the name used by Zgoubi, this must match the Zgoubi manual. Then follows a line for each line of output in the zgoubi.dat file; first the names of the parameters, then a &#8216;:&#8217;, then the types. For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>BEND
BEND
IL : I
XL, Sk, B1 : 3E
X_E, LAM_E, W_E : 3E
N, C_0, C_1, C_2, C_3, C_4, C_5 : I,6E
X_S, LAM_S, W_S : 3E
NS, CS_0, CS_1, CS_2, CS_3, CS_4, CS_5 : I,6E
XPAS: X
KPOS, XCE, YCE, ALE : I,3E
</pre></div>
</div>
<p>The types can be:</p>
<ul class="simple">
<li>I : integer</li>
<li>E : real (floating point)</li>
<li>Ax : string with up to x characters</li>
<li>X : special type for XPAS. Can be integer, or group of 3 integers e.g. (10,20,10)</li>
</ul>
<p>The type can be followed by a number for several parameters of the same type.</p>
<p>If the parameters used vary depending on the value of another option the following syntax can be used:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>CAVITE
CAVITE
IOPT : I
!IOPT==0
X, X : 2E
!IOPT==1
L, h : 2E
V, X : 2E
!IOPT==2
L, h : 2E
V, sig_s : 2E
!IOPT==3
X,X : 2E
V, sig_s : 2E
</pre></div>
</div>
<p>Here the value of IOPT switches the element to output different parameters. (See the zgoubi manual&#8217;s description of CAVITE for more info).</p>
<p>Elements with a looped section can be defined as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>FFAG
FFAG
IL : I
N, AT, RM: I,2E
!N*{
ACN, DELTA_RM, BZ_0, K: 4E
G0_E, KAPPA_E: 2E
NCE, CE_0, CE_1, CE_2, CE_3, CE_4, CE_5, SHIFT_E: I,7E
OMEGA_E, THETA_E, R1_E, U1_E, U2_E, R2_E: 6E
G0_S, KAPPA_S: 2E
NCS, CS_0, CS_1, CS_2, CS_3, CS_4, CS_5, SHIFT_S: I,7E
OMEGA_S, THETA_S, R1_S, U1_S, U2_S, R2_S: 6E
G0_L, KAPPA_L: 2E
NCL, CL_0, CL_1, CL_2, CL_3, CL_4, CL_5, SHIFT_L: I,7E
OMEGA_L, THETA_L, R1_L, U1_L, U2_L, R2_L: 6E
!}
KIRD, RESOL: 2I
XPAS: E
KPOS, RE, TE, RS, TS: I,4E
</pre></div>
</div>
<p>Here the section between the braces is repeated. These elements are used slightly differently to simpler elements. Then non looping section is defined normally.:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>triplet = FFAG(&#39;triplet&#39;, IL=0, AT=10 ... )
</pre></div>
</div>
<p>Then the looped part can be added:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>triplet.add(ACN = 6, BZ_0 = 0.5 ...)
triplet.add(ACN = 4, BZ_0 = -0.5 ...)
triplet.add(ACN = 6, BZ_0 = 0.5 ...)
</pre></div>
</div>
<p>N gets automatically set. All the looped parts can be removed using:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">triplet</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</pre></div>
</div>
<p>When pyzgoubi runs it searches the defs folder for files ending in .defs. Additional files can be added to the extra_defs_files list in zgoubi_settings.py. If any of these files have been modified then they are reread and the defs.py is regenerated.</p>
<p>The Elements that cannot be defined in this way must be put into the static_defs.py file. They must be classes that have an output() method, which generates the code needed for the zgoubi.dat file.</p>
<p>There is also a FAKE_ELEM element. This allows you to put arbitrary text into the zgoubi.dat file. It is useful for using an Zgoubi element that pyzgoubi does not have a definition for. For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">change_txt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&#39;CHANGREF&#39;</span>
<span class="s2">5.0 0 10.0</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">change</span> <span class="o">=</span> <span class="n">FAKE_ELEM</span><span class="p">(</span><span class="n">change_txt</span><span class="p">)</span>
<span class="n">line</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">change</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="available-elements">
<h3>Available Elements<a class="headerlink" href="#available-elements" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>BEND</li>
<li>CAVITE</li>
<li>CHANGREF</li>
<li>DRIFT</li>
<li>ELECTRON</li>
<li>END</li>
<li>FAISCEAU</li>
<li>FAISCNL</li>
<li>FAISTORE</li>
<li>FAKE_ELEM</li>
<li>FFAG</li>
<li>IMMORTAL_MUON</li>
<li>MARKER</li>
<li>MATRIX</li>
<li>MULTIPOL</li>
<li>MUON</li>
<li>OBJET1</li>
<li>OBJET2</li>
<li>OBJET5</li>
<li>PARTICUL</li>
<li>PROTON</li>
<li>QUADRUPO</li>
<li>REBELOTE</li>
<li>TOSCA</li>
</ul>
<p>To find the full list of elements available in the current version run:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>pyzgoubi --help elements
</pre></div>
</div>
<p>To find the names of the parameters available for an element use:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>pyzgoubi --help element_name
</pre></div>
</div>
<p>e.g.:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>pyzgoubi --help MULTIPOL
</pre></div>
</div>
<p>Use this in combination with the Zgoubi manual. Most parameters have the same name. Greek letters in the manual are usually anglicised  (e.g. τ to tau). Subscripts are represented with underscores. When there is a entrance and exit version of a parameter E (entrée) and S (sortie) are used to distinguish.</p>
</div>
</div>
<div class="section" id="running-zgoubi">
<h2>Running Zgoubi<a class="headerlink" href="#running-zgoubi" title="Permalink to this headline">¶</a></h2>
<p>Once a <a class="reference internal" href="api.html#zgoubi.core.Line" title="zgoubi.core.Line"><tt class="xref py py-class docutils literal"><span class="pre">Line</span></tt></a> has been created and had the needed elements added it can be run. PyZgoubi will take care of creating a temporary directory, creating the zgoubi.dat file and running Zgoubi. This is done to prevent zgoubi from overwriting any existing files. If you wish to keep any of the output files you must use the commands to copy these to where you want them.</p>
<p>The following example shows how to run a <a class="reference internal" href="api.html#zgoubi.core.Line" title="zgoubi.core.Line"><tt class="xref py py-class docutils literal"><span class="pre">Line</span></tt></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1">#create line</span>
<span class="n">emma</span> <span class="o">=</span> <span class="n">Line</span><span class="p">(</span><span class="s1">&#39;emma&#39;</span><span class="p">)</span>

<span class="c1">#add elements</span>
<span class="n">emma</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="o">...</span>  <span class="p">)</span>
<span class="o">...</span>

<span class="c1">#run line</span>
<span class="n">emma_res</span> <span class="o">=</span> <span class="n">emma</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="c1">#save output</span>
<span class="n">emma_res</span><span class="o">.</span><span class="n">save_res</span><span class="p">(</span><span class="s2">&quot;emma.res&quot;</span><span class="p">)</span>
<span class="n">emma_res</span><span class="o">.</span><span class="n">save_plt</span><span class="p">(</span><span class="s2">&quot;emma.plt&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that you will need to make sure your <a class="reference internal" href="api.html#zgoubi.core.Line" title="zgoubi.core.Line"><tt class="xref py py-class docutils literal"><span class="pre">Line</span></tt></a> will actually create plt or fai files, otherwise you will receive a file not found error. See the Zgoubi manual for more information.</p>
<p>The <a class="reference internal" href="api.html#zgoubi.core.Line.run" title="zgoubi.core.Line.run"><tt class="xref py py-func docutils literal"><span class="pre">run()</span></tt></a> function can take several options. If you want to inspect the directory where zgoubi is run, or to use zpop, then set xterm=True. If you want to change the directory that zgoubi is run in you can use the tmp_prefix option. It is best to make sure this is a local disk (i.e. not a network/remote disk). The default directory can be set in the zgoubi_settings.py file.:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">emma</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">xterm</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">emma</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tmp_prefix</span> <span class="o">=</span> <span class="s1">&#39;/var/tmp/sam/&#39;</span><span class="p">)</span>
<span class="n">emma</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">xterm</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">tmp_prefix</span> <span class="o">=</span> <span class="s1">&#39;/home/sam/tmp/&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>If you want to do analysis of the simulation you can use the <a class="reference internal" href="api.html#zgoubi.core.Results" title="zgoubi.core.Results"><tt class="xref py py-class docutils literal"><span class="pre">Results</span></tt></a> object that is returned by the <a class="reference internal" href="api.html#zgoubi.core.Line.run" title="zgoubi.core.Line.run"><tt class="xref py py-func docutils literal"><span class="pre">run()</span></tt></a> function.:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="n">emma</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>See the <a class="reference internal" href="api.html#zgoubi.core.Results" title="zgoubi.core.Results"><tt class="xref py py-class docutils literal"><span class="pre">Results</span></tt></a> Object chapter for more info.</p>
<p>Each time a <a class="reference internal" href="api.html#zgoubi.core.Line" title="zgoubi.core.Line"><tt class="xref py py-class docutils literal"><span class="pre">Line</span></tt></a> is run a temporary director is created. These are normally automatically cleared up when PyZgoubi finishes (also the /tmp directory is usually emptied when a computer shuts down). However if you are making repeated calls to <a class="reference internal" href="api.html#zgoubi.core.Line.run" title="zgoubi.core.Line.run"><tt class="xref py py-func docutils literal"><span class="pre">run()</span></tt></a>, then you may want to manually clear away these files. This can be done with the <a class="reference internal" href="api.html#zgoubi.core.Results.clean" title="zgoubi.core.Results.clean"><tt class="xref py py-func docutils literal"><span class="pre">clean()</span></tt></a> function. Don&#8217;t clean the <a class="reference internal" href="api.html#zgoubi.core.Results" title="zgoubi.core.Results"><tt class="xref py py-class docutils literal"><span class="pre">Results</span></tt></a> until you have finished working with its output files.:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="n">emma</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="n">res</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="results-object">
<h2>Results Object<a class="headerlink" href="#results-object" title="Permalink to this headline">¶</a></h2>
<p>When you run a <a class="reference internal" href="api.html#zgoubi.core.Line" title="zgoubi.core.Line"><tt class="xref py py-class docutils literal"><span class="pre">Line</span></tt></a> it creates a <a class="reference internal" href="api.html#zgoubi.core.Results" title="zgoubi.core.Results"><tt class="xref py py-class docutils literal"><span class="pre">Results</span></tt></a> object, that can be used to get information about the paths of the particles.:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="n">pamela</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p><a class="reference internal" href="api.html#zgoubi.core.Results.get_all" title="zgoubi.core.Results.get_all"><tt class="xref py py-func docutils literal"><span class="pre">get_all()</span></tt></a> and <a class="reference internal" href="api.html#zgoubi.core.Results.get_track" title="zgoubi.core.Results.get_track"><tt class="xref py py-func docutils literal"><span class="pre">get_track()</span></tt></a>, let you get lists of the particle coordinates. They each need to be told if they should read the plt (points within the magnetic elements) or fai (beam at FAISCNL element). <a class="reference internal" href="api.html#zgoubi.core.Results.get_all" title="zgoubi.core.Results.get_all"><tt class="xref py py-func docutils literal"><span class="pre">get_all()</span></tt></a> returns a list of dictionaries, containing all the coordinates and information. <a class="reference internal" href="api.html#zgoubi.core.Results.get_track" title="zgoubi.core.Results.get_track"><tt class="xref py py-func docutils literal"><span class="pre">get_track()</span></tt></a> returns a list of lists of just the requested coordinates.:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">print</span> <span class="n">res</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="s1">&#39;plt&#39;</span><span class="p">)</span>
<span class="k">print</span> <span class="n">res</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="s1">&#39;fai&#39;</span><span class="p">)</span>
<span class="k">print</span> <span class="n">res</span><span class="o">.</span><span class="n">get_track</span><span class="p">(</span><span class="s1">&#39;fai&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;T&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>Assuming that you are using a recent Zgoubi version get_all will return a numpy structured array (recarray) which has named columns. To see the names of the columns use:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">fai_data</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="s1">&#39;fai&#39;</span><span class="p">)</span>
<span class="k">print</span> <span class="n">fai_data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span>
</pre></div>
</div>
<p>To find the units look inside a zgoubi.fai file.</p>
</div>
<div class="section" id="bunch-objects">
<h2>Bunch Objects<a class="headerlink" href="#bunch-objects" title="Permalink to this headline">¶</a></h2>
<p>New in Pyzgoubi 0.4</p>
<p>The <a class="reference internal" href="api.html#zgoubi.bunch.Bunch" title="zgoubi.bunch.Bunch"><tt class="xref py py-class docutils literal"><span class="pre">Bunch</span></tt></a> object represents a bunch of particles. Each particle has coordinates D, Y, T, Z, P, S, tof, and X, and the whole bunch has the shared properties rigidity/kinetic energy, particle mass, particle charge. These are stored in m, rad, eV, s, and automatically converted to Zgoubi units by the associated  functions.</p>
<p>It can be used in 2 ways. Firstly with the OBJET_bunch element, which behaves similarly to the real OBJET elements. Secondly it can be used to drive Zgoubi in a more abstracted method.</p>
<p>To use with OBJET_bunch, first create a bunch, then create an OBJET_bunch, then add it to a <a class="reference internal" href="api.html#zgoubi.core.Line" title="zgoubi.core.Line"><tt class="xref py py-class docutils literal"><span class="pre">Line</span></tt></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">my_bunch</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span><span class="n">nparticles</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ke</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="n">PROTON_MASS</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">my_bunch</span><span class="o">.</span><span class="n">particles</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
<span class="o">...</span>

<span class="n">ob</span> <span class="o">=</span> <span class="n">OBJET_bunch</span><span class="p">(</span><span class="n">bunch</span><span class="o">=</span><span class="n">my_bunch</span><span class="p">)</span>
<span class="n">my_line</span> <span class="o">=</span> <span class="n">Line</span><span class="p">(</span><span class="s2">&quot;a line&quot;</span><span class="p">)</span>
<span class="n">my_line</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ob</span><span class="p">)</span>
<span class="n">my_line</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="o">...</span> <span class="p">)</span>
</pre></div>
</div>
<p>This <a class="reference internal" href="api.html#zgoubi.core.Line" title="zgoubi.core.Line"><tt class="xref py py-class docutils literal"><span class="pre">Line</span></tt></a> can then be run as before.</p>
<p>The second method is to create a <a class="reference internal" href="api.html#zgoubi.core.Line" title="zgoubi.core.Line"><tt class="xref py py-class docutils literal"><span class="pre">Line</span></tt></a> that has no OBJET, PARTICUL or END elements, only beamline elements. Then the <a class="reference internal" href="api.html#zgoubi.core.Line.track_bunch" title="zgoubi.core.Line.track_bunch"><tt class="xref py py-func docutils literal"><span class="pre">Line.track_bunch</span></tt></a> method can be called, which will return the tracked bunch:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">my_line</span> <span class="o">=</span> <span class="n">Line</span><span class="p">(</span><span class="s2">&quot;a line&quot;</span><span class="p">)</span>
<span class="n">my_line</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">QUADRUPO</span><span class="p">(</span> <span class="o">...</span> <span class="p">)</span> <span class="p">)</span>
<span class="n">my_line</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">DRIFT</span><span class="p">(</span> <span class="o">...</span> <span class="p">)</span> <span class="p">)</span>
<span class="o">...</span>
<span class="n">my_bunch2</span> <span class="o">=</span> <span class="n">my_line</span><span class="o">.</span><span class="n">track_bunch</span><span class="p">(</span><span class="n">my_bunch</span><span class="p">)</span>
</pre></div>
</div>
<p>This allows tracking a bunch around multiple lattices. Suppose that you create 3 <a class="reference internal" href="api.html#zgoubi.core.Line" title="zgoubi.core.Line"><tt class="xref py py-class docutils literal"><span class="pre">Lines</span></tt></a>: injecttion_line, ring and extraction_line. You can then take a bunch through each in turn:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">my_bunch</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span> <span class="o">...</span> <span class="p">)</span>

<span class="n">my_bunch</span> <span class="o">=</span> <span class="n">injecttion_line</span><span class="o">.</span><span class="n">track_bunch</span><span class="p">(</span><span class="n">my_bunch</span><span class="p">)</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n_laps</span><span class="p">):</span>
        <span class="n">my_bunch</span> <span class="o">=</span> <span class="n">ring</span><span class="o">.</span><span class="n">track_bunch</span><span class="p">(</span><span class="n">my_bunch</span><span class="p">)</span>
<span class="n">my_bunch</span> <span class="o">=</span> <span class="n">extraction_line</span><span class="o">.</span><span class="n">track_bunch</span><span class="p">(</span><span class="n">my_bunch</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that this method does not allow you to access the Result object.</p>
<p>If you have a multi-CPU or multi-core CPU, then you can swap <a class="reference internal" href="api.html#zgoubi.core.Line.track_bunch" title="zgoubi.core.Line.track_bunch"><tt class="xref py py-func docutils literal"><span class="pre">Line.track_bunch</span></tt></a> for the multithreaded version <a class="reference internal" href="api.html#zgoubi.core.Line.track_bunch_mt" title="zgoubi.core.Line.track_bunch_mt"><tt class="xref py py-func docutils literal"><span class="pre">Line.track_bunch_mt</span></tt></a>. The multithreaded version also has the advantage that it can track an arbitrarily large bunch (more than Zgoubi&#8217;s max particles limit).</p>
<p>There are a number of generators for standard bunches, e.g Kapchinskij-Vladimirskij (KV), waterbag and Guassian:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">gen_gauss_x_xp_y_yp</span><span class="p">(</span><span class="n">npart</span><span class="p">,</span> <span class="n">emit_y</span><span class="p">,</span> <span class="n">emit_z</span><span class="p">,</span> <span class="n">beta_y</span><span class="p">,</span> <span class="n">beta_z</span><span class="p">,</span> <span class="n">alpha_y</span><span class="p">,</span> <span class="n">alpha_z</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ke</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">rigidity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">gen_gauss_x_xp_y_yp_s_dp</span><span class="p">(</span><span class="n">npart</span><span class="p">,</span> <span class="n">emit_y</span><span class="p">,</span> <span class="n">emit_z</span><span class="p">,</span> <span class="n">beta_y</span><span class="p">,</span> <span class="n">beta_z</span><span class="p">,</span> <span class="n">alpha_y</span><span class="p">,</span> <span class="n">alpha_z</span><span class="p">,</span> <span class="n">mom_spread</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bunch_length</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">disp_prime</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ke</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">rigidity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">gen_halo_x_xp_y_yp</span><span class="p">(</span><span class="n">npart</span><span class="p">,</span> <span class="n">emit_y</span><span class="p">,</span> <span class="n">emit_z</span><span class="p">,</span> <span class="n">beta_y</span><span class="p">,</span> <span class="n">beta_z</span><span class="p">,</span> <span class="n">alpha_y</span><span class="p">,</span> <span class="n">alpha_z</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ke</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">rigidity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">gen_kv_x_xp_y_yp</span><span class="p">(</span><span class="n">npart</span><span class="p">,</span> <span class="n">emit_y</span><span class="p">,</span> <span class="n">emit_z</span><span class="p">,</span> <span class="n">beta_y</span><span class="p">,</span> <span class="n">beta_z</span><span class="p">,</span> <span class="n">alpha_y</span><span class="p">,</span> <span class="n">alpha_z</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ke</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">rigidity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">gen_waterbag_x_xp_y_yp</span><span class="p">(</span><span class="n">npart</span><span class="p">,</span> <span class="n">emit_y</span><span class="p">,</span> <span class="n">emit_z</span><span class="p">,</span> <span class="n">beta_y</span><span class="p">,</span> <span class="n">beta_z</span><span class="p">,</span> <span class="n">alpha_y</span><span class="p">,</span> <span class="n">alpha_z</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ke</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">rigidity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>For example to create a KV bunch with 1000 protons:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">my_bunch</span> <span class="o">=</span> <span class="n">Bunch</span><span class="o">.</span><span class="n">gen_kv_x_xp_y_yp</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="mf">2e-2</span><span class="p">,</span> <span class="n">ke</span><span class="o">=</span><span class="mf">50e6</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="n">PROTON_MASS</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="complex-lines">
<h2>Complex Lines<a class="headerlink" href="#complex-lines" title="Permalink to this headline">¶</a></h2>
<p>It is often useful to break down a complex lattice into sections and cells. This can be done in several ways in PyZgoubi.</p>
<p>Firstly you can use python features such as loops, e.g. to put 5 identical FODO cells you could use</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">line</span> <span class="o">=</span> <span class="n">Line</span><span class="p">(</span><span class="s2">&quot;example&quot;</span><span class="p">)</span>

<span class="n">line</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="o">...</span> <span class="p">)</span>
<span class="n">line</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="o">...</span> <span class="p">)</span>

<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">line</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">QUADRUPO</span><span class="p">(</span> <span class="o">...</span> <span class="p">))</span>
    <span class="n">line</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">DRIFT</span><span class="p">(</span> <span class="o">...</span> <span class="p">))</span>
    <span class="n">line</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">QUADRUPO</span><span class="p">(</span> <span class="o">...</span> <span class="p">))</span>
    <span class="n">line</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">DRIFT</span><span class="p">(</span> <span class="o">...</span> <span class="p">))</span>

<span class="n">line</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="o">...</span> <span class="p">)</span>
</pre></div>
</div>
<p>Note that the for loop block lasts as long as the code is indented.</p>
<p>If you want to make one iteration different then you can do a test based on the x</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>for x in range(5):
    line.add(QUADRUPO( ... ))
    line.add(DRIFT( ... ))
    line.add(QUADRUPO( ... ))
    line.add(DRIFT( ... ))
    if (x == 2): #note x counts from zero
        line.add(DIPOLE( ... )
</pre></div>
</div>
<p>Another method is to make a <a class="reference internal" href="api.html#zgoubi.core.Line" title="zgoubi.core.Line"><tt class="xref py py-class docutils literal"><span class="pre">Line</span></tt></a> for each cell, and then build the full lattice from the cells:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">cell1</span> <span class="o">=</span> <span class="n">Line</span><span class="p">(</span><span class="s2">&quot;cell1&quot;</span><span class="p">)</span>
<span class="n">cell1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">cell1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="n">cell2</span> <span class="o">=</span> <span class="n">Line</span><span class="p">(</span><span class="s2">&quot;cell2&quot;</span><span class="p">)</span>
<span class="n">cell2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">cell2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="n">full_line</span> <span class="o">=</span> <span class="n">Line</span><span class="p">(</span><span class="s2">&quot;fullline&quot;</span><span class="p">)</span>
<span class="n">full_line</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cell1</span><span class="p">)</span>
<span class="n">full_line</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cell2</span><span class="p">)</span>
<span class="c1">#or</span>
<span class="n">full_line</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cell1</span><span class="p">,</span> <span class="n">cell2</span><span class="p">)</span>
</pre></div>
</div>
<p>The +, * and - operators are overloaded for the line to add, repeat and reverse them.For example, assuming that you have defined the Lines <tt class="docutils literal"><span class="pre">injection</span></tt>, <tt class="docutils literal"><span class="pre">extraction</span></tt> and <tt class="docutils literal"><span class="pre">ring_cell</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">full_line</span> <span class="o">=</span> <span class="n">injection</span> <span class="o">+</span> <span class="n">n</span> <span class="o">*</span> <span class="n">ring_cell</span> <span class="o">+</span> <span class="n">extraction</span>
</pre></div>
</div>
<p>To use a cell with its elements in reverse order:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">full_line</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">-</span><span class="n">cell1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="command-line-arguments">
<h2>Command line arguments<a class="headerlink" href="#command-line-arguments" title="Permalink to this headline">¶</a></h2>
<p>There is a convenience function for using command line arguments. For example near the start of the code put:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">number_of_laps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">get_cmd_param</span><span class="p">(</span><span class="s1">&#39;laps&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
<p>Then when creating the <a class="reference internal" href="api.html#zgoubi.core.Line" title="zgoubi.core.Line"><tt class="xref py py-class docutils literal"><span class="pre">Line</span></tt></a> use:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">l</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">REBELOTE</span><span class="p">(</span><span class="n">NPASS</span><span class="o">=</span><span class="n">number_of_laps</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">KWRIT</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mi">99</span><span class="p">))</span>
</pre></div>
</div>
<p>to access the variable. When you run the your simulation use the command line argument:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>pyzgoubi sim.py laps=50
</pre></div>
</div>
<p>I the second parameter to get_cmd_param() is the default. If you don&#8217;t give a value as an argument then the default is used. If you don&#8217;t give a default eg:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">particle_energy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">get_cmd_param</span><span class="p">(</span><span class="s1">&#39;energy&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>then you will receive and error if you don&#8217;t provide a value as an argument.</p>
</div>
<div class="section" id="units">
<h2>Units<a class="headerlink" href="#units" title="Permalink to this headline">¶</a></h2>
<p>PyZgoubi does not do any automatic unit conversion. When you give a parameter you must give the units that Zgoubi expects. However PyZgoubi does define some values to save some effort, in the conversion. Any of the following will set x to 2:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">m</span>
<span class="n">x</span> <span class="o">=</span> <span class="mi">200</span> <span class="o">*</span> <span class="n">cm</span>
<span class="n">x</span> <span class="o">=</span> <span class="mi">2000</span> <span class="o">*</span> <span class="n">mm</span>
</pre></div>
</div>
<p>Then to output x in a different unit:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">print</span> <span class="n">x</span> <span class="o">*</span> <span class="n">m_</span> <span class="p">,</span> <span class="s2">&quot;m&quot;</span>
<span class="k">print</span> <span class="n">x</span> <span class="o">*</span> <span class="n">cm_</span> <span class="p">,</span> <span class="s2">&quot;cm&quot;</span>
<span class="k">print</span> <span class="n">x</span> <span class="o">*</span> <span class="n">mm_</span> <span class="p">,</span> <span class="s2">&quot;mm&quot;</span>
</pre></div>
</div>
<p>So for example DRIFT expects cm, but your lattice might use meters, so do:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">d_length</span> <span class="o">=</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="n">m</span>
<span class="n">DRIFT</span><span class="p">(</span><span class="s1">&#39;d1&#39;</span><span class="p">,</span> <span class="n">XL</span><span class="o">=</span><span class="n">d_length</span><span class="o">*</span><span class="n">cm_</span><span class="p">)</span>
</pre></div>
</div>
<p>Currently the following units are defined:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">m</span>
<span class="n">cm</span>
<span class="n">mm</span>
<span class="n">T</span>
<span class="n">kgauss</span>
</pre></div>
</div>
<p>but more can be added on request.</p>
<p>For conversion between degrees and radians use the python math functions:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">degrees</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span> <span class="c1"># gives 360</span>
<span class="n">radians</span><span class="p">(</span><span class="mi">180</span><span class="p">)</span> <span class="c1"># gives 3.1416...</span>
</pre></div>
</div>
</div>
<div class="section" id="settings-and-options">
<h2>Settings and Options<a class="headerlink" href="#settings-and-options" title="Permalink to this headline">¶</a></h2>
<p>PyZgoubi settings are stored in a file .pyzgoubi/settings.ini in your home folder. It is automatically created the first time pyzgoubi is used. It can be used to customise some PyZgoubi options.</p>
<p>The following keys can be set:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">extra_defs_files</span>
</pre></div>
</div>
<p>Give the path of any additional definition files you want to be considered:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">tmp_dir</span>
</pre></div>
</div>
<p>Where temporary files should be written, this is most likely /tmp/, but in some case you may wish to use /var/tmp/ or a ramdisk /dev/shm/:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">zgoubi_path</span>
</pre></div>
</div>
<p>The path to the zgoubi binary file. Note that this can also be set with the commandline option &#8211;zgoubi=/path/to/zgoubi.</p>
<div class="section" id="debugging-and-profiling">
<h3>Debugging and Profiling<a class="headerlink" href="#debugging-and-profiling" title="Permalink to this headline">¶</a></h3>
<p>PyZgoubi can be run with pythons interactive mode (same as &#8220;python -i&#8221;) so that in the event of an error the user is given a python prompt to inspect variables at the point of the exception.:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>pyzgoubi -i script.py
</pre></div>
</div>
<p>PyZgoubi can generate profiles using the cProfile module. use:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>pyzgoubi --profile script.py
</pre></div>
</div>
<p>The profiling information can be read with the python pstats module (part of cProfile). For example to see in which functions most time was spent run:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>python -c &quot;import pstats; pstats.Stats(&#39;prof.log&#39;).sort_stats(&#39;cumulative&#39;).print_stats()&quot;
</pre></div>
</div>
<p>or start a python shell and run:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">pstats</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">pstats</span><span class="o">.</span><span class="n">Stats</span><span class="p">(</span><span class="s1">&#39;prof.log&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">sort_stats</span><span class="p">(</span><span class="s1">&#39;cumulative&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">print_stats</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="logging-levels">
<span id="logging"></span><h3>Logging levels<a class="headerlink" href="#logging-levels" title="Permalink to this headline">¶</a></h3>
<p>The verbosity of PyZgoubi can be adjusted. By default the log_level is set to &#8216;warn&#8217;, so only warnings and error messages are printed. One can raise the level to &#8216;debug&#8217; which will also show debug messages. To do this for a single run use:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>pyzgoubi --debug script
or
pyzgoubi --log_level=debug script
</pre></div>
</div>
<p>or you can adjust the value in the settings.ini file:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">log_level</span> <span class="o">=</span> <span class="n">debug</span>
</pre></div>
</div>
<p>Other levels can also be set, see <a class="reference external" href="http://docs.python.org/library/logging.html">http://docs.python.org/library/logging.html</a> for more information.</p>
</div>
</div>
<div class="section" id="upgrade-notes">
<h2>Upgrade Notes<a class="headerlink" href="#upgrade-notes" title="Permalink to this headline">¶</a></h2>
<p>Although it would be nice to have perfect backwards compatibility that sometimes interferes with progress, and things have to break. There should be no breaks between a version X.Y.Z and X.Y.Z+1, but there can be between X.Y.Z and X.Y+1.0.</p>
<div class="section" id="x-to-0-4-x">
<h3>0.3.x to 0.4.x<a class="headerlink" href="#x-to-0-4-x" title="Permalink to this headline">¶</a></h3>
<p>PyZgoubi 0.4 supports the new fai/plt output formats introduced into Zgoubi in early 2010. These have a header that labels the columns. Reading the new format was taken as an opportunity to use numpy more extensively. If an older version of Zgoubi (5.1 or 5.0) is being used then the old fai/plt reading code will be used, and data will be returned as python dictionaries and arrays. If a newer version of Zgoubi is being used (SVN r251 or newer), then Results.get_all() will return a <a class="reference external" href="http://docs.scipy.org/doc/numpy/user/basics.rec.html">numpy structured array</a> with the column names.</p>
<p>Some column names will change when using the new fai/plt files. This is because older versions of PyZgoubi muddled the S and X coordinates. Also &#8216;D&#8217; and &#8216;D0&#8217; are now the more accurate &#8216;D-1&#8217; and &#8216;D0-1&#8217;. The coordinate name is now taken from the fai/plt file directly.</p>
<p>When using the new fai/plt files labels are stored as a fixed length string, and so include any whitespace, e.g. &#8216;foc&#8217; vs. &#8216;foc&#8217;. To  get back to the short version use strip(), e.g.:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">label1</span> <span class="o">=</span> <span class="s1">&#39;foc     &#39;</span>
<span class="n">label_short</span> <span class="o">=</span> <span class="n">label1</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="c1">#or</span>
<span class="n">labels1</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;foc     &#39;</span><span class="p">,</span> <span class="s1">&#39;defoc   &#39;</span><span class="p">]</span>
<span class="n">labels2</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">labels1</span><span class="p">]</span>
</pre></div>
</div>
<p>The &#8216;tol&#8217; parameter in find_closed_orbit() now is a measure of convergence rather than area. This should give better results over a wide range of scales. However, a large &#8216;tol&#8217; is needed to give the same degree of accuracy. If you previously had tol=1e-10, then it may no longer converge, but if you change it to tol=1e-6 you will get a similar result to before.</p>
<p>Some obsolete functions have been removed: Results.plt_to_csv(), Results.get_all_old(), Line.split_line()</p>
<p>Some obsolete functions have been marked as deprecated, and will give warnings when used. These will likely be removed in a future version of PyZgoubi, unless you let me know that they are worth keeping. Some of these functions are old and undocumented, and I suspect no one uses them. Some have just move, like the functions for directly accessing and saving res and fai files (moved from Line to Results). If you do not care about modifying you&#8217;re code to prepare for a future version then pass the argument <tt class="docutils literal"><span class="pre">-W</span> <span class="pre">ignore::DeprecationWarning</span></tt> to python.</p>
</div>
</div>
<div class="section" id="tips">
<h2>Tips<a class="headerlink" href="#tips" title="Permalink to this headline">¶</a></h2>
<div class="section" id="python-hints">
<h3>Python hints<a class="headerlink" href="#python-hints" title="Permalink to this headline">¶</a></h3>
<p>If there is a &#8216;#&#8217; character on a line, everything after it is treated as a comment.</p>
<p>Python uses whitespace to delimit blocks (instead of braces &#8216;{&#8216; and &#8216;}&#8217; in C/C++). The PyZgoubi code uses tabs, so it is best to use tabs in your input files. If you get an &#8216;IndentationError&#8217; check that you have not mixed spaces and tabs, or accidentally started a line with a space/tab.</p>
<p>Python identifiers (variable, function, object names etc) are case sensitive, they must start with a letter and only contain letters, numbers and underscores.</p>
</div>
<div class="section" id="zgoubi-hints">
<h3>Zgoubi hints<a class="headerlink" href="#zgoubi-hints" title="Permalink to this headline">¶</a></h3>
<div class="section" id="errors">
<h4>Errors<a class="headerlink" href="#errors" title="Permalink to this headline">¶</a></h4>
<p>sfe: formatted io not allowed:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>Zgoubi, version 5.0.0.
Job  started  on  05-Feb-09,  at  15:00:29
Copying  zgoubi.dat  into  zgoubi.res,
numbering  and  labeling  elements...

acc                              Zgoubi Version 5.0.0.

366/  367 REBELOTE                    sfe: formatted io not allowed
apparent state: unit 21 named zgoubi.res
lately writing sequential formatted external IO
</pre></div>
</div>
<p>This may mean that you have tried to write output to both ascii and binary files, eg zgoubi.fai and b_zgoubi.fai</p>
</div>
</div>
</div>
<div class="section" id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h2>
<p>There are several levels at which problems can occur. Errors in the input file, bugs in PyZgoubi, bugs in Zgoubi.</p>
<div class="section" id="debug-mode">
<h3>Debug mode<a class="headerlink" href="#debug-mode" title="Permalink to this headline">¶</a></h3>
<p>Some useful information is shown when debugging is enabled, for example warnings about common mistakes. See <a class="reference internal" href="#logging"><em>Logging levels</em></a>.</p>
</div>
<div class="section" id="check-the-line">
<h3>Check the line<a class="headerlink" href="#check-the-line" title="Permalink to this headline">¶</a></h3>
<p>Printing the line instance will show what elements it contains:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">my_line</span> <span class="o">=</span> <span class="n">Line</span><span class="p">(</span><span class="s2">&quot;a line&quot;</span><span class="p">)</span>
<span class="n">my_line</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">QUADRUPO</span><span class="p">(</span> <span class="o">...</span> <span class="p">)</span> <span class="p">)</span>
<span class="n">my_line</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">DRIFT</span><span class="p">(</span> <span class="o">...</span> <span class="p">)</span> <span class="p">)</span>
<span class="o">...</span>
<span class="k">print</span> <span class="n">my_line</span>
</pre></div>
</div>
</div>
<div class="section" id="element-output">
<h3>Element output<a class="headerlink" href="#element-output" title="Permalink to this headline">¶</a></h3>
<p>Check what an element is outputting to the zgoubi.dat file:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">q1</span> <span class="o">=</span> <span class="n">QUADRUPO</span><span class="p">(</span> <span class="o">...</span> <span class="p">)</span>
<span class="k">print</span> <span class="n">q1</span><span class="o">.</span><span class="n">output</span><span class="p">()</span>
</pre></div>
</div>
<p>or the whole line:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">print</span> <span class="n">my_line</span><span class="o">.</span><span class="n">output</span>
</pre></div>
</div>
<p>If they are not what you expect have a look in PyZgoubi&#8217;s definition files.</p>
</div>
<div class="section" id="res-file">
<h3>Res file<a class="headerlink" href="#res-file" title="Permalink to this headline">¶</a></h3>
<p>Read the zgoubi.res file. It shows how Zgoubi interpreted the zgoubi.dat file:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">my_line</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="k">print</span> <span class="n">results</span><span class="o">.</span><span class="n">res</span><span class="p">()</span>
</pre></div>
</div>
<p>Check all the units, Zgoubi uses a range of different units.</p>
</div>
<div class="section" id="xterm">
<h3>xterm<a class="headerlink" href="#xterm" title="Permalink to this headline">¶</a></h3>
<p>Open an xterm in the temp working folder, and have a look at the files zgoubi has output:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">my_line</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">xterm</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>From here you can modify the zgoubi.dat and run zgoubi again.</p>
</div>
<div class="section" id="memory-issues">
<h3>Memory Issues<a class="headerlink" href="#memory-issues" title="Permalink to this headline">¶</a></h3>
<p>Zgoubi uses statically allocated arrays with sizes set at compile time for storage of elements, particle, field maps etc. When it starts it will allocate several GB of memory that it may not actually use. If you are on a low memory machine (less that 4GB) you may see the message:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>Check that you have sufficient RAM or enable memory overcommit
</pre></div>
</div>
<p>If you are on Linux you maybe able to work around this by adjusting your memory overcommit settings. This allows programs to make allocations larger than the available memory, they will be stopped if they actually try to use all of this memory. Unless you are using large field maps you are unlikely to use all the memory that Zgoubi allocates. To allow over committing adjust the sysctl value vm.overcommit_memory with the command:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>sysctl vm.overcommit_memory=1
</pre></div>
</div>
<p>Or by editing the file /etc/sysctl.conf. See <a class="reference external" href="https://www.kernel.org/doc/Documentation/vm/overcommit-accounting">https://www.kernel.org/doc/Documentation/vm/overcommit-accounting</a> for more details.</p>
</div>
<div class="section" id="matplotlib-issues">
<h3>Matplotlib Issues<a class="headerlink" href="#matplotlib-issues" title="Permalink to this headline">¶</a></h3>
<p>If you see the error:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>ImportError: No module named backend_tkagg
</pre></div>
</div>
<p>You need to install the matplotlib tk backend, for example the package python-matplotlib-tk. If this is not possible you can switch to a different default plotting backend by editing (or creating) a matplotlib config file (.config/matplotlib/matplotlibrc or .matplotlib/matplotlibrc on linux), for example add the line:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>backend : Agg
</pre></div>
</div>
<p>There are a range of backends to choose from, see <a class="reference external" href="http://matplotlib.org/faq/usage_faq.html#what-is-a-backend">http://matplotlib.org/faq/usage_faq.html#what-is-a-backend</a> .</p>
</div>
<div class="section" id="limit-issues">
<h3>Limit issues<a class="headerlink" href="#limit-issues" title="Permalink to this headline">¶</a></h3>
<p>Zgoubi stores many things in fixed sized arrays. If you reach the limit of these you might see an error such as:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>Y-dim of map is too large, max is  200   Occured in element # 4,  at pass # 1

PROCEDURE STOPPED: too many elements
</pre></div>
</div>
<p>If so you can rebuild Zgoubi with larger settings, see <a class="reference internal" href="install.html#automaticzgoubiinstall"><em>Automatic Zgoubi install</em></a>.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">PyZgoubi Documentation</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#quick-start">Quick Start</a></li>
<li><a class="reference internal" href="#generating-zgoubi-dat-files">Generating zgoubi.dat files</a><ul>
<li><a class="reference internal" href="#particles-particuls">Particles / Particuls</a></li>
</ul>
</li>
<li><a class="reference internal" href="#defining-elements">Defining Elements</a><ul>
<li><a class="reference internal" href="#available-elements">Available Elements</a></li>
</ul>
</li>
<li><a class="reference internal" href="#running-zgoubi">Running Zgoubi</a></li>
<li><a class="reference internal" href="#results-object">Results Object</a></li>
<li><a class="reference internal" href="#bunch-objects">Bunch Objects</a></li>
<li><a class="reference internal" href="#complex-lines">Complex Lines</a></li>
<li><a class="reference internal" href="#command-line-arguments">Command line arguments</a></li>
<li><a class="reference internal" href="#units">Units</a></li>
<li><a class="reference internal" href="#settings-and-options">Settings and Options</a><ul>
<li><a class="reference internal" href="#debugging-and-profiling">Debugging and Profiling</a></li>
<li><a class="reference internal" href="#logging-levels">Logging levels</a></li>
</ul>
</li>
<li><a class="reference internal" href="#upgrade-notes">Upgrade Notes</a><ul>
<li><a class="reference internal" href="#x-to-0-4-x">0.3.x to 0.4.x</a></li>
</ul>
</li>
<li><a class="reference internal" href="#tips">Tips</a><ul>
<li><a class="reference internal" href="#python-hints">Python hints</a></li>
<li><a class="reference internal" href="#zgoubi-hints">Zgoubi hints</a><ul>
<li><a class="reference internal" href="#errors">Errors</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#troubleshooting">Troubleshooting</a><ul>
<li><a class="reference internal" href="#debug-mode">Debug mode</a></li>
<li><a class="reference internal" href="#check-the-line">Check the line</a></li>
<li><a class="reference internal" href="#element-output">Element output</a></li>
<li><a class="reference internal" href="#res-file">Res file</a></li>
<li><a class="reference internal" href="#xterm">xterm</a></li>
<li><a class="reference internal" href="#memory-issues">Memory Issues</a></li>
<li><a class="reference internal" href="#matplotlib-issues">Matplotlib Issues</a></li>
<li><a class="reference internal" href="#limit-issues">Limit issues</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="install.html"
                        title="previous chapter">PyZgoubi Installation</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="api.html"
                        title="next chapter">API Reference</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/doc.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="api.html" title="API Reference"
             >next</a> |</li>
        <li class="right" >
          <a href="install.html" title="PyZgoubi Installation"
             >previous</a> |</li>
        <li><a href="index.html">PyZgoubi 0.6.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2016, Sam Tygier.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>