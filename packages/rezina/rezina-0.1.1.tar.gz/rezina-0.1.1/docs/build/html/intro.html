<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Rezina &mdash; regina 1 documentation</title>
    
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="regina 1 documentation" href="index.html" />
    <link rel="next" title="periodically schedule" href="periodicallyschedule.html" />
    <link rel="prev" title="Installation" href="installation.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="periodicallyschedule.html" title="periodically schedule"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="installation.html" title="Installation"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">regina 1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="rezina">
<h1>Rezina<a class="headerlink" href="#rezina" title="Permalink to this headline">¶</a></h1>
<p>rezina is a scalable, distributed and easy to use system for executing python code in parallel across multiple processors or many machines.  It provides a simple way to make parallel programming in python more easier, flexible and scalable and shipped with  features like periodically schedule, load balance, fail tolerate, dynamically add tasks and save result to backend.</p>
</div>
<div class="section" id="why-use-rezina">
<h1>why use rezina?<a class="headerlink" href="#why-use-rezina" title="Permalink to this headline">¶</a></h1>
<p>Consider this task, I want to gather weather data of ten cities from yahoo weather api. I wrote a scirpt <cite>cityweather.py</cite> to do this.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>liufujiaodeMacBook-Pro:workspace liufujiao$ time python cityweather.py
{&#39;city&#39;: &#39;Beijing&#39;, &#39;weather&#39;: u&#39;Mostly Sunny&#39;}
{&#39;city&#39;: &#39;Berlin&#39;, &#39;weather&#39;: u&#39;Partly Cloudy&#39;}
{&#39;city&#39;: &#39;New York&#39;, &#39;weather&#39;: u&#39;Mostly Clear&#39;}
{&#39;city&#39;: &#39;London&#39;, &#39;weather&#39;: u&#39;Mostly Cloudy&#39;}
{&#39;city&#39;: &#39;Tokyo&#39;, &#39;weather&#39;: u&#39;Mostly Sunny&#39;}
{&#39;city&#39;: &#39;Paris&#39;, &#39;weather&#39;: u&#39;Mostly Cloudy&#39;}
{&#39;city&#39;: &#39;Chicago&#39;, &#39;weather&#39;: u&#39;Partly Cloudy&#39;}
{&#39;city&#39;: &#39;washington&#39;, &#39;weather&#39;: u&#39;Clear&#39;}
{&#39;city&#39;: &#39;Venice&#39;, &#39;weather&#39;: u&#39;Breezy&#39;}
{&#39;city&#39;: &#39;Houston&#39;, &#39;weather&#39;: u&#39;Breezy&#39;}

real 0m18.726s
user 0m0.080s
sys  0m0.034s
</pre></div>
</div>
<p>The whole process of fetching data take 20s and we could think one city takes 2s on average.</p>
<p>Now here is the problem, what if I want to get the ten weather data every 10 seconds so I could always know the least weather?  this requires all data should be fetched in 10s.</p>
<p>One simple way to do this is we could start more threads (or processes) to fetch data in parallel and implement logic to run periodically.</p>
<p>Problem again, now I want to get weather data of 50,000 cities so I can build a weather website to provide weather conditions for my user, how to do it?</p>
<p>One server could not launch 10,000 threads. maybe we could split all cites into several parts and run every part with threads on different servers, but this kind of solution need consider the following problems.</p>
<ul class="simple">
<li>what if one or more servers down?</li>
<li>what if we want to add or remove some cites?</li>
<li>what if we want to launch more processes for time consuming logic?</li>
<li>what if we want to change the fetch interval from 10s to 5s.</li>
<li>what if we want to save data in another backend?</li>
<li>…</li>
</ul>
<p>We need a easier and flexible way to execute tasks in parallel without pay much attentions on these problems and make us focus only on our business logic. this is the motivation of rezina project.</p>
<p>See Quick Guide for how rezina do this.</p>
</div>
<div class="section" id="support">
<h1>Support<a class="headerlink" href="#support" title="Permalink to this headline">¶</a></h1>
<p><strong>Python</strong></p>
<ul class="simple">
<li>python2.7</li>
<li>python3.5</li>
</ul>
<p><strong>OS</strong></p>
<ul class="simple">
<li>OS X</li>
<li>Linux</li>
</ul>
</div>
<div class="section" id="dependencies">
<h1>Dependencies<a class="headerlink" href="#dependencies" title="Permalink to this headline">¶</a></h1>
<p>rezina requires <a class="reference external" href="https://github.com/zeromq/pyzmq">pyzmq</a> for message transports.</p>
<p>pyzmq is python bindings for <a class="reference external" href="http://zeromq.org/">ØMQ</a>. ØMQ is a lightweight and fast messaging implementation.</p>
</div>
<div class="section" id="installaion">
<h1>Installaion<a class="headerlink" href="#installaion" title="Permalink to this headline">¶</a></h1>
<p>You can install reizna either via the Python Package Index (PyPI) or from source.</p>
<p>To install using pip:</p>
<p><code class="docutils literal"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">rezina</span></code></p>
<div class="section" id="downloading-and-installing-from-source">
<h2>Downloading and installing from source<a class="headerlink" href="#downloading-and-installing-from-source" title="Permalink to this headline">¶</a></h2>
<p>Before install rezina, <a class="reference external" href="https://github.com/zeromq/pyzmq#building-and-installation">building-and-installation</a>
pyzmq first.</p>
<p>After pyzmq installed, download the latest version of rezina from PyPI:</p>
<p><a class="reference external" href="http://pypi.python.org/pypi/rezina">http://pypi.python.org/pypi/rezina</a></p>
<p>and install it by doing the following:</p>
<p><code class="docutils literal"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">/path/to/rezina-0.x.y.tar.gz</span></code></p>
<p>or</p>
<p><code class="docutils literal"><span class="pre">tar</span> <span class="pre">xvfz</span> <span class="pre">rezina-0.x.y.tar.gz</span></code></p>
<p><code class="docutils literal"><span class="pre">cd</span> <span class="pre">rezina-0.x.y</span></code></p>
<p><code class="docutils literal"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">install</span></code></p>
</div>
</div>
<div class="section" id="quick-guide">
<h1>Quick Guide<a class="headerlink" href="#quick-guide" title="Permalink to this headline">¶</a></h1>
<div class="section" id="start-rezina">
<h2>Start rezina<a class="headerlink" href="#start-rezina" title="Permalink to this headline">¶</a></h2>
<p>Once rezina is installed, you can run</p>
<p><code class="docutils literal"><span class="pre">rezina-cli</span> <span class="pre">runmaster</span> <span class="pre">-H</span> <span class="pre">master_ip</span></code></p>
<p>to start rezina master, and run</p>
<p><code class="docutils literal"><span class="pre">rezina-cli</span> <span class="pre">runworker</span> <span class="pre">-H</span> <span class="pre">master_ip</span> <span class="pre">-WIP</span> <span class="pre">worker_ip</span></code></p>
<p>to start rezina worker</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">we could use <cite>-D</cite> to run master as daemon and <cite>-W</cite> to specify a new workspace. please see documentation for starting rezina correctly.</p>
</div>
</div>
<div class="section" id="example-cityweather">
<h2>Example cityweather<a class="headerlink" href="#example-cityweather" title="Permalink to this headline">¶</a></h2>
<div class="section" id="cityweather-code">
<h3>cityweather code<a class="headerlink" href="#cityweather-code" title="Permalink to this headline">¶</a></h3>
<p>script name: <code class="docutils literal"><span class="pre">cityweather.py</span></code></p>
<p>put this script into rezina workspace (<code class="docutils literal"><span class="pre">~/rezina/workspace</span></code> by default, use -W /path/to/your/workspace when starting master if you want to change it)</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/evn python</span>

<span class="kn">import</span> <span class="nn">urllib2</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">json</span>


<span class="k">def</span> <span class="nf">get_cities</span><span class="p">():</span>
    <span class="n">cities</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Beijing&#39;</span><span class="p">,</span> <span class="s1">&#39;Berlin&#39;</span><span class="p">,</span> <span class="s1">&#39;New York&#39;</span><span class="p">,</span> <span class="s1">&#39;London&#39;</span><span class="p">,</span> <span class="s1">&#39;Tokyo&#39;</span><span class="p">,</span> <span class="s1">&#39;Paris&#39;</span><span class="p">,</span>
              <span class="s1">&#39;Chicago&#39;</span><span class="p">,</span> <span class="s1">&#39;washington&#39;</span><span class="p">,</span> <span class="s1">&#39;Venice&#39;</span><span class="p">,</span> <span class="s1">&#39;Houston&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">cities</span>


<span class="c1"># get city weather data from yahoo weather api</span>
<span class="k">def</span> <span class="nf">get_city_weather</span><span class="p">(</span><span class="n">city</span><span class="p">):</span>
    <span class="n">baseurl</span> <span class="o">=</span> <span class="s2">&quot;https://query.yahooapis.com/v1/public/yql?&quot;</span>
    <span class="n">yql_query</span> <span class="o">=</span> <span class="s2">&quot;select item.condition.text from weather.forecast </span><span class="se">\</span>
<span class="s2">                 where woeid in (select woeid from geo.places(1) </span><span class="se">\</span>
<span class="s2">                 where text=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">city</span><span class="p">)</span>
    <span class="n">yql_url</span> <span class="o">=</span> <span class="n">baseurl</span> <span class="o">+</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">({</span><span class="s1">&#39;q&#39;</span><span class="p">:</span> <span class="n">yql_query</span><span class="p">})</span> <span class="o">+</span> <span class="s2">&quot;&amp;format=json&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">yql_url</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="c1"># because resule from yahoo api does not include the city name, we add it.</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">city</span>
    <span class="k">return</span> <span class="n">data</span>


<span class="c1"># process diffrent output and convert data to a simple format</span>
<span class="k">def</span> <span class="nf">one_word_conditions_for_city</span><span class="p">(</span><span class="n">city_weather_result</span><span class="p">):</span>
    <span class="n">simple_format_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">simple_format_data</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">city_weather_result</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">city_weather_result</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">][</span><span class="s1">&#39;results&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">weather</span> <span class="o">=</span> <span class="n">city_weather_result</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">][</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;channel&#39;</span><span class="p">][</span><span class="s1">&#39;item&#39;</span><span class="p">][</span><span class="s1">&#39;condition&#39;</span><span class="p">][</span><span class="s1">&#39;text&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">weather</span> <span class="o">=</span> <span class="s2">&quot;Unkonw&quot;</span>  <span class="c1"># simplely set unkonw when result is not avaliable</span>
    <span class="n">simple_format_data</span><span class="p">[</span><span class="s1">&#39;weather&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weather</span>
    <span class="k">return</span> <span class="n">simple_format_data</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">city</span> <span class="ow">in</span> <span class="n">get_cities</span><span class="p">():</span>
        <span class="nb">print</span> <span class="n">one_word_conditions_for_city</span><span class="p">(</span><span class="n">get_city_weather</span><span class="p">(</span><span class="n">city</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="build-a-typology-to-run-cityweather-with-rezina">
<h3>Build a typology to run cityweather with rezina<a class="headerlink" href="#build-a-typology-to-run-cityweather-with-rezina" title="Permalink to this headline">¶</a></h3>
<p>script name: <code class="docutils literal"><span class="pre">weathertypo.py</span></code></p>
<p>put it info rezina workspace</p>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p class="last">you could regard hydrant, notch, bocca as input, filter, output respectively for now. A typology looks like <cite>input | filter1 | filter2 | output</cite> in shell. check the Documentation for more info.</p>
</div>
<p>run <code class="docutils literal"><span class="pre">get_city_weather</span></code> function with 2 processes and every process run 5 threads and each thread fetch one city.</p>
<p>run <code class="docutils literal"><span class="pre">one_word_conditions_for_city</span></code> function with 1 process with 1 thread because it is not time consuming one.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">from</span> <span class="nn">rezina.utils.network</span> <span class="k">import</span> <span class="n">get_ip</span>
<span class="kn">from</span> <span class="nn">rezina</span> <span class="k">import</span> <span class="n">TypologyBuilder</span>
<span class="kn">from</span> <span class="nn">rezina.backends</span> <span class="k">import</span> <span class="n">Stdout</span>

<span class="kn">from</span> <span class="nn">cityweather</span> <span class="k">import</span> <span class="n">get_cities</span><span class="p">,</span> <span class="n">get_city_weather</span><span class="p">,</span> <span class="n">one_word_conditions_for_city</span>

<span class="n">ip</span> <span class="o">=</span> <span class="n">get_ip</span><span class="p">()</span>  <span class="c1"># get master_ip</span>
<span class="n">tb</span> <span class="o">=</span> <span class="n">TypologyBuilder</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">12345</span><span class="p">,</span> <span class="s1">&#39;weather_typo2&#39;</span><span class="p">)</span>
<span class="n">tb</span><span class="o">.</span><span class="n">add_hydrant</span><span class="p">(</span><span class="n">get_cities</span><span class="p">)</span>
<span class="n">tb</span><span class="o">.</span><span class="n">add_notch</span><span class="p">(</span><span class="n">get_city_weather</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">tb</span><span class="o">.</span><span class="n">add_notch</span><span class="p">(</span><span class="n">one_word_conditions_for_city</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">tb</span><span class="o">.</span><span class="n">add_bocca</span><span class="p">(</span><span class="n">Stdout</span><span class="p">,</span> <span class="n">persistent_mode</span><span class="o">=</span><span class="s1">&#39;stream&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">restart</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="run-typology">
<h3>run typology<a class="headerlink" href="#run-typology" title="Permalink to this headline">¶</a></h3>
<p>rezina typology file is just a python script, run it with</p>
<p><code class="docutils literal"><span class="pre">python</span> <span class="pre">weathertypo.py</span></code> or <code class="docutils literal"><span class="pre">./weathertypo.py`</span></code> and you get the results.</p>
<p>you could also save the results of your typology to another backend rather than print them.</p>
<p>See documentation for more details.</p>
</div>
</div>
<div class="section" id="rezina-console">
<h2>rezina console<a class="headerlink" href="#rezina-console" title="Permalink to this headline">¶</a></h2>
<p>rezina provides command line tool and web console to manage master, workers, typologies.</p>
<p>you could run</p>
<p><code class="docutils literal"><span class="pre">`rezina-cli</span> <span class="pre">runconsole</span> <span class="pre">-H</span> <span class="pre">master_ip</span></code></p>
<blockquote>
<div>to start cml or access <code class="docutils literal"><span class="pre">master_ip:31218</span></code> to see web console.</div></blockquote>
</div>
</div>
<div class="section" id="documentation">
<h1>Documentation<a class="headerlink" href="#documentation" title="Permalink to this headline">¶</a></h1>
<p>See <a class="reference external" href="http://rezina.readthedocs.io/en/latest/">http://rezina.readthedocs.io/en/latest/</a> for more info.</p>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Rezina</a></li>
<li><a class="reference internal" href="#why-use-rezina">why use rezina?</a></li>
<li><a class="reference internal" href="#support">Support</a></li>
<li><a class="reference internal" href="#dependencies">Dependencies</a></li>
<li><a class="reference internal" href="#installaion">Installaion</a><ul>
<li><a class="reference internal" href="#downloading-and-installing-from-source">Downloading and installing from source</a></li>
</ul>
</li>
<li><a class="reference internal" href="#quick-guide">Quick Guide</a><ul>
<li><a class="reference internal" href="#start-rezina">Start rezina</a></li>
<li><a class="reference internal" href="#example-cityweather">Example cityweather</a><ul>
<li><a class="reference internal" href="#cityweather-code">cityweather code</a></li>
<li><a class="reference internal" href="#build-a-typology-to-run-cityweather-with-rezina">Build a typology to run cityweather with rezina</a></li>
<li><a class="reference internal" href="#run-typology">run typology</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rezina-console">rezina console</a></li>
</ul>
</li>
<li><a class="reference internal" href="#documentation">Documentation</a></li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="installation.html"
                        title="previous chapter">Installation</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="periodicallyschedule.html"
                        title="next chapter">periodically schedule</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/intro.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="periodicallyschedule.html" title="periodically schedule"
             >next</a> |</li>
        <li class="right" >
          <a href="installation.html" title="Installation"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">regina 1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2015, Fujiao Liu.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.5.
    </div>
  </body>
</html>