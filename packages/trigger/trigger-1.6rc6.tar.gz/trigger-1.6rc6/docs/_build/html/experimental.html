

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Experimental &mdash; Trigger 1.6.rc4 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Trigger 1.6.rc4 documentation" href="index.html"/>
        <link rel="next" title="Changelog" href="changelog.html"/>
        <link rel="prev" title="Getting Help" href="support.html"/>
 
<style type="text/css">
    span.changelog-support {color: #4070A0;}
    span.changelog-bug {color: #A04040;}
    span.changelog-feature {color: #40A056;}
    a.changelog-release {font-weight: bold;}
</style>


  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Trigger
          

          
          </a>

          
            
            
              <div class="version">
                1.6.rc4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="platforms.html">Supported Platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage/index.html">Usage Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Usage Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/index.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="development.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="support.html">Getting Help</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Experimental</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#asynchronous-endpoint-feature">Asynchronous Endpoint Feature</a></li>
<li class="toctree-l2"><a class="reference internal" href="#preamble">Preamble</a></li>
<li class="toctree-l2"><a class="reference internal" href="#code">Code</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Trigger</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Experimental</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/experimental.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="experimental">
<h1>Experimental<a class="headerlink" href="#experimental" title="Permalink to this headline">¶</a></h1>
<p>This document describes experimental features currently in development as part of the Trigger re-architecture.</p>
<div class="section" id="asynchronous-endpoint-feature">
<h2>Asynchronous Endpoint Feature<a class="headerlink" href="#asynchronous-endpoint-feature" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="api/netdevices.html#trigger.netdevices.NetDevice" title="trigger.netdevices.NetDevice"><code class="xref py py-obj docutils literal"><span class="pre">NetDevice</span></code></a> objects now contain interface methods for connect and command execution.
This is in contrast to traditional trigger whereby interaction with a given device is not re-entrant.</p>
<p>The following is a breakdown of these new API structures see <code class="docutils literal"><span class="pre">examples/sshendpoint_updatecmdb.py</span></code> at project root for more details.</p>
</div>
<div class="section" id="preamble">
<h2>Preamble<a class="headerlink" href="#preamble" title="Permalink to this headline">¶</a></h2>
<p>The code below defines two functions.</p>
<ol class="arabic simple">
<li><code class="xref py py-obj docutils literal"><span class="pre">StringProducer</span></code> is an interface for the data that will be POST&#8217;d by the Twisted http client.</li>
<li><code class="xref py py-obj docutils literal"><span class="pre">update_cmdb</span></code> is a callback function that will be fired upon the return of <code class="xref py py-obj docutils literal"><span class="pre">show</span> <span class="pre">version</span></code> on the remote endpoint.
The purpose of this function is to POST the current IOS version into a CMDB system.</li>
</ol>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">twisted.internet.defer</span> <span class="k">import</span> <span class="n">Deferred</span>
<span class="kn">from</span> <span class="nn">zope.interface</span> <span class="k">import</span> <span class="n">implements</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="k">import</span> <span class="n">reactor</span>
<span class="kn">from</span> <span class="nn">twisted.web.client</span> <span class="k">import</span> <span class="n">Agent</span>
<span class="kn">from</span> <span class="nn">twisted.web.http_headers</span> <span class="k">import</span> <span class="n">Headers</span>
<span class="kn">from</span> <span class="nn">twisted.internet.defer</span> <span class="k">import</span> <span class="n">succeed</span>
<span class="kn">from</span> <span class="nn">twisted.web.iweb</span> <span class="k">import</span> <span class="n">IBodyProducer</span>
<span class="c1"># from twisted.python import log</span>
<span class="c1"># log.startLogging(sys.stdout, setStdout=False)</span>
<span class="kn">from</span> <span class="nn">trigger.netdevices</span> <span class="k">import</span> <span class="n">NetDevices</span>

<span class="c1"># Create reference to upgraded switch.</span>
<span class="n">nd</span> <span class="o">=</span> <span class="n">NetDevices</span><span class="p">()</span>
<span class="n">dev</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;arista-sw1.demo.local&#39;</span><span class="p">)</span>

<span class="c1"># Create payload body</span>
<span class="k">class</span> <span class="nc">StringProducer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">implements</span><span class="p">(</span><span class="n">IBodyProducer</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">startProducing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">consumer</span><span class="p">):</span>
        <span class="n">consumer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">succeed</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pauseProducing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">stopProducing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<span class="k">def</span> <span class="nf">update_cmdb</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">re</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;Software image version: (4.12.0-1244667)&#39;</span><span class="p">)</span>
    <span class="n">os</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span><span class="n">reactor</span><span class="p">)</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">StringProducer</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    {{&#39;Devices&#39;:[</span>
<span class="s2">        {{Name:&#39;</span><span class="si">{name}</span><span class="s2">&#39;, OS:&#39;</span><span class="si">{os}</span><span class="s2">&#39;}}</span>
<span class="s2">    ]}}&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">nodeName</span><span class="p">,</span> <span class="n">os</span><span class="o">=</span><span class="n">os</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
        <span class="s1">&#39;GET&#39;</span><span class="p">,</span>
        <span class="s1">&#39;http://192.168.1.194/&#39;</span><span class="p">,</span>
        <span class="n">Headers</span><span class="p">({</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Twisted Web Client Example&#39;</span><span class="p">],</span>
                 <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;application/json&#39;</span><span class="p">]}),</span>
        <span class="n">body</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cbResponse</span><span class="p">(</span><span class="n">ignored</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s1">&#39;Response received&#39;</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">cbResponse</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="code">
<h2>Code<a class="headerlink" href="#code" title="Permalink to this headline">¶</a></h2>
<p>Below details the code needed to actually run the command on the device and process the results asynchronously.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Open connection to device.</span>
<span class="nb">print</span> <span class="s2">&quot;Begin example. Please wait while we extract the OS version from </span><span class="si">{name}</span><span class="s2">&#39;s show version output.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">dev</span><span class="o">.</span><span class="n">nodeName</span><span class="p">)</span>
<span class="n">dev</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>

<span class="c1"># Pause due to timing inconsistencies experienced in some devices.</span>
<span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># Execute some commands</span>
<span class="n">r10</span> <span class="o">=</span> <span class="n">dev</span><span class="o">.</span><span class="n">run_channeled_commands</span><span class="p">([</span><span class="s1">&#39;show version&#39;</span><span class="p">])</span>

<span class="c1"># Perform update cmdb action based on the output of arista-sw1&#39;s show version.</span>
<span class="n">r10</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">update_cmdb</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span>
<span class="n">r10</span><span class="o">.</span><span class="n">addBoth</span><span class="p">(</span><span class="n">dev</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
</pre></div>
</div>
<p>We can continue to make asynchronous calls without having to restart the running process. With this in mind we could perform an action if the device
is not running on our minimum baseline version. This could be achieved like so:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Open connection to device.</span>
<span class="nb">print</span> <span class="s2">&quot;Begin example. Please wait while we extract the OS version from </span><span class="si">{name}</span><span class="s2">&#39;s show version output.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">dev</span><span class="o">.</span><span class="n">nodeName</span><span class="p">)</span>
<span class="n">dev</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">update_device</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">re</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;Software image version: (4.12.0)&#39;</span><span class="p">)</span>
    <span class="n">os</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># If OS is not at baseline, copy latest code to flash</span>
    <span class="k">if</span> <span class="n">os</span> <span class="o">&lt;</span> <span class="mf">4.12</span><span class="o">.</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">r10</span><span class="o">.</span><span class="n">dev</span><span class="o">.</span><span class="n">run_channeled_commands</span><span class="p">([</span><span class="s1">&#39;copy tftp://192.168.1.1/my-os.code flash: /md5&#39;</span><span class="p">,</span> <span class="s1">&#39;config t&#39;</span><span class="p">,</span> <span class="s1">&#39;boot system flash:my-os.code&#39;</span><span class="p">])</span>

<span class="c1"># Pause due to timing inconsistencies experienced in some devices.</span>
<span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># Execute some commands</span>
<span class="n">r10</span> <span class="o">=</span> <span class="n">dev</span><span class="o">.</span><span class="n">run_channeled_commands</span><span class="p">([</span><span class="s1">&#39;show version&#39;</span><span class="p">])</span>

<span class="c1"># Perform update cmdb action based on the output of arista-sw1&#39;s show version.</span>
<span class="n">r10</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">update_device</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span>
<span class="n">r10</span><span class="o">.</span><span class="n">addBoth</span><span class="p">(</span><span class="n">dev</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
</pre></div>
</div>
<p>This is a contrived example. If doing something like this in product it is recommended to take the output of the md5 hash and compare it to a pre-compiled value associated with the file sitting on the tftp server.</p>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="changelog.html" class="btn btn-neutral float-right" title="Changelog" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="support.html" class="btn btn-neutral" title="Getting Help" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2006-2016, AOL Inc.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'1.6.rc4',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>