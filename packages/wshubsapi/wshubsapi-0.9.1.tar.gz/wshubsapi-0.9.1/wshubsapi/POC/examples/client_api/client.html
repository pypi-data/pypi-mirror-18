<html>
<head>
    <title>tornado WebSocket example</title>
    <!--File auto-generated by the server.
    Path needs to match with Hub.construct_js_file path parameter-->
    <script type="text/javascript" src="client_api/WSHubsApi.js"></script>
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.4.2.js"></script>
</head>
<body>
<div>
    <h1>WebSocket example with WSHubsAPI</h1>
    <hr>
    WebSocket status : <span id="status">Waiting connection</span><br>
    Name: <input type="text" id="name" value="Kevin"/><br>
    <input type="text" id="message" />
    <input type="button" id="sendmessage" value="Send" />
    <input type="hidden" id="displayname" />
    <ul id="discussion">
    </ul>
</div>
<script>
    var hubsApi = new HubsAPI('ws://127.0.0.1:8888/');
    function sendToAll() {
        var name = $('#name').val(),
            message = $('#message').val();
        $('#discussion').append('<li><strong> Me'
            + '</strong>: ' + message + '</li>');


        hubsApi.EchoHub.server.echo(name, message)
            .then(function (numOfMessagesSent) {
                console.log("message sent to " + numOfMessagesSent + " client(s)");
            }, function (err) {
                console.log("message not sent " + err);
            }).finally(function () {
            console.log("I am in finnally");
        });
        $('#message').val('').focus();
    }

    hubsApi.connect().then(function () {
        $('#status').text("Connected");

        //function to be called from server
        hubsApi.ChatHub.client.onMessage = function (from, message) {
            $('#discussion').append('<li><strong>' + from
                + '</strong>: ' + message + '</li>');
            return "received"
        }
    });

    $('#sendmessage').click(sendToAll);
    $('#message').keypress(function (e) {
        if (e.which == 13)
            sendToAll()
    });
</script>
</body>
</html>